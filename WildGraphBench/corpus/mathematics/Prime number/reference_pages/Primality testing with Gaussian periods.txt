# Primality testing with Gaussian periods

Primality testing with Gaussian periods version 11 December, 2016 

Primality testing with Gaussian periods 

H. W. Lenstra jr. and Carl Pomerance 

Abstract. We exhibit a deterministic algorithm that, for some effectively computable real number c, decides whether a given integer n> 1 is prime within time (log n)6 ·(2+log log n)c. The same result, with 21 /2 in the place of 6, was proved by Agrawal, Kayal, and Saxena. Our algorithm follows the same pattern as theirs, performing computations in an auxiliary ring extension of Z/n Z. We allow our rings to be generated by Gaussian periods rather than by roots of unity, which leaves us greater freedom in the selection of the auxiliary parameters and enables us to obtain a better run time estimate. The proof depends on results in analytic number theory and on the following theorem from additive number theory, which was provided by D. Bleichenbacher: if t is a real number with 0 <t ≤1, and following theorem from additive number theory, which was provided by D. Bleichenbacher: if 

t is a real number with 0 <t ≤1, and S is an open subset of the interval (0 ,t ) with 

∫ 

> S

dx/x>t , then each real number greater than or equal to 1 is in the additive semigroup generated by S. A byproduct of our main result is an improved algorithm for constructing finite fields of given characteristic and approximately given degree. 

Key words: primality testing, constructing finite fields, Frobenius problem. 

1991 Mathematics subject classification: 11Y11, 11N13, 11P70, 12Y05. 

Acknowledgements. We thank several people for their assistance, in particular Daniel Bernstein, Daniel Blei-chenbacher, Andrew Granville, Vsevolod Lev, Willem Jan Palenstijn, Francesco Pappalardi, Jonathan Pila, Peter Stevenhagen, Mark Watkins, and Alessandro Zaccagnini. We thank the Max Planck Institute for Mathematics in Bonn for its hospitality in Fall, 2016, during which time we completed this paper. 

Contents 

1. Introduction (2–6) 2. Pseudofields and period systems (6–9) 3. The primality test (9–11) 4. Constructing finite fields (11–13) 5. Algebraic properties of pseudofields (13–16) 6. Primality testing with pseudofields (16–18) 7. Tensor products (19–22) 8. Gaussian periods (22–26) 9. The continuous Frobenius problem (26–31) 10. A number-theoretic application (32–36) 11. The distribution of primes in residue classes (36–40) 12. Sieved primes (40–44) 13. The existence of period systems (44–47) References (47–49) 11. Introduction 

Our main result reads as follows. 

Theorem 1. There exists, for some effectively computable real number c0, a deterministic algorithm that, given an integer n with n > 1, decides whether or not n is prime, and does so in time at most (log n)6 · (2 + log log n)c0 .

We shall exhibit an algorithm with the stated properties. Its run time is measured in bit operations. The constant c0 is effectively computable in the sense that our proof of the existence of c0, combined with the proofs in the papers to which we refer, implicitly contains an algorithm for computing c0.The same result, but with the run time exponent 6 replaced by 21 /2, was obtained by Agrawal, Kayal, and Saxena [2]. They also prove a result with run time exponent 15 /2 (in which “ c0” is not effectively computable), and they argue that the true run time exponent of their algorithm may reasonably be conjectured to equal 6. We achieve the exponent 6 not by proving their conjecture, but by modifying their algorithm. A fundamentally new idea would be required to obtain a deterministic primality test-ing algorithm with run time exponent smaller than 6. For probabilistic primality tests the situation is different. Bernstein [6], also elaborating on [2] and building on an idea of Berrizbeitia [9], exhibited a probabilistic algorithm that, for some effectively com-putable constant c1, has the following property. Given any integer n > 1, the algorithm correctly decides whether or not n is prime, and it does so in expected time at most (log n)4 · (2 + log log n)c1 log log log(22 log n). See [4] for a similar result. Like [2], the present paper has an algebraic and an analytic component, addressing the correctness and the efficiency of the algorithm, respectively. By working harder on the algebra, we leave the algorithm greater freedom in the selection of auxiliary parameters, thus simplifying the analytic problem of obtaining a good run time estimate. Specifically, both the algorithm of [2] and our own algorithm perform computations in a suitable ring extension of the ring Z/n Z of integers modulo n; if d denotes the “degree” of the extension, then the run time estimate becomes d3/2 · (log n)3 times a lower order factor, and the problem of obtaining a small run time exponent boils down to proving a good upper bound for the smallest d that can be used. Agrawal et al. use the ring ( Z/n Z)[ X]/(Xd − 1), and find that the problem of accurately estimating the least usable value for d leads to an unsolved problem in analytic number theory. We select our ring extension from a much wider class, for which estimating d becomes feasible. 2The ring extensions of Z/n Z that we use shall be referred to as pseudofields . If n

is a prime number, then these pseudofields are in fact finite fields , and our construction of pseudofields is inspired by a construction of finite fields proposed by Adleman and Lenstra [1]. They describe a deterministic algorithm that, for certain effectively computable constants c2 and c3, has the following properties: given a prime number p and a positive integer D, it computes an irreducible polynomial f in ( Z/p Z)[ X] satisfying D ≤ deg f ≤

c2D log p, and it does so within time ( D + log p)c3 . The ring ( Z/p Z)[ X]/(f ) is then a finite field of given characteristic p of degree “close” to a given number D. Our construction improves upon this result when D is not too small. 

Theorem 2. There exist an effectively computable positive integer c4 and a deterministic algorithm such that the following holds. Given a prime number p and a positive integer D

with D > (log p)46 /25 , the algorithm computes an irreducible polynomial f in (Z/p Z)[ X]

with D ≤ deg f < 2D and has run time at most (D log p) · (2 + log D + log log p)c4 .

Note that the run time of our algorithm is essentially linear in terms of the length of the output. Under mild restrictions we may narrow the interval [ D, 2D) to [ D, (1 + ǫ)D) for small positive values of ǫ, see Theorem 4.4. There is a deterministic algorithm that produces an irreducible polynomial in Fp[X] of exact degree D and that runs in polynomial time assuming the Generalized Riemann Hypothesis, see [1]. In addition, there is a probabilistic algorithm to do the same that runs in expected time ˜O(D2 log p + D log 2 p), see [28], where the notation ˜O is defined below. Adleman and Lenstra [1] construct the finite field ( Z/p Z)[ X]/(f ) by adjoining to 

Z/p Z a certain set of Gaussian periods parametrized by what we call a period system . For Theorem 2, we use almost exactly the same construction, but we are much more careful in selecting the period system, so that we are able to narrow the interval [ D, c 2D log p] for the degree down to [ D, 2D), and even narrower, in a large range. The proof that an appropriate period system can be found, is the major technical hurdle we have to take; our desire that the constants in Theorem 1 and Theorem 2 be effectively computable has added to the difficulties. An auxiliary result, which has independent interest, was provided by D. Bleichenba-cher [10], who kindly allowed us to include his result and its proof. The Frobenius postage problem asks for the largest number which is not in the additive semigroup generated by a given set of coprime positive integers. Bleichenbacher’s theorem considers a continuous version of this problem. A similar result was obtained by Lev [24]. 3Theorem 3. Suppose S is an open subset of the set of positive real numbers that is closed under addition and for which 1 6 ∈ S. Then for each real number t ∈ (0 , 1] one has 

∫ 

> S∩(0 ,t )

dx/x ≤ t.

We give a number-theoretic application of Theorem 3, a simplified version of which is the following. 

Theorem 4. For every real number α with 0 < α ≤ 1/2, there is a positive integer 

x0, effectively computable when α is rational, with the following property. If x, u are real numbers with 

x > x 0, 1

α < u < (log x)1/10 

and Q is a set of primes contained in (x1/u , x 1/2] with 

∑

> q∈Q

1

q ≥ α, 

then there is a squarefree number in [x1/α , 2x1/α ) composed solely of primes in Q.

Our proofs of Theorems 1 and 2 depend on the existence of many primes r where r − 1has certain multiplicative constraints. It has been known since Erd˝ os [18] that there is a positive constant E such that for a positive proportion of all primes r the number r − 1 is composed solely of primes in (1 , r 1−E ]; and he conjectured that this holds for each choice of E less than 1. Since then many people have worked on this problem, with the current record being any number E < 1 − 1/(2 √e). The proof (in Friedlander [20]) is modeled on a similar result of Balog [5], who obtained the slightly weaker assertion that the number of primes in (1 , x ] with the desired property is at least proportional to x/ (log x)2. We follow Balog’s approach to prove the following theorem. 

Theorem 5. If x > 1 is a real number and Q is a set of primes in the interval (1 , x 1/2],let R(x, Q) denote the number of primes r ≤ x with r − 1 composed solely of primes in (1 , x 1/2] \ Q . There are effectively computable positive numbers X0, δ , with X0, δ −1

integers, such that if x ≥ X0 and R(x, Q) < δx/ (log x)2, then 

∑

> q∈Q

1

q − 1 > 0.2727 .

That the numbers X0, δ in Theorem 5 are effectively computable has us forgo certain standard tools, such as the prime-number estimates of Bombieri, Friedlander, and Iwaniec. 4In addition we need to modify another tool, namely the Bombieri–Vinogradov theorem. The major “off-the-shelf” tool that we do employ is a result of Deshouillers and Iwaniec [17] on the Brun–Titchmarsh theorem on average. The connection of Theorems 4 and 5 to our problem is as follows. Our pseudofields are built up to have their degrees as close as possible to a given target degree. We construct a certain set of primes Q, showing that we can attain degrees equal to subset products of Q.Our set Q is constructed to satisfy the hypotheses of Theorem 5. Theorem 4 is then used to show that there are indeed squarefree numbers close to a given target which are built solely from primes in Q.In Section 2 we define pseudofields and period systems, and we state all properties of these concepts that go into our proofs. Taking these results for granted, we prove Theorem 1 in Section 3 and Theorem 2 in Section 4. In Sections 5–8 we prove the properties of pseudofields stated in Section 2. A proof of Theorem 3 is found in Section 9. In Section 10 we apply Theorem 3 to prove a somewhat stronger version of Theorem 4. In Sections 11– 12 we use analytic number theory to prove Theorem 5. In Section 13, we use the result of Section 10 plus Theorem 5 to show the existence result for period systems stated in Section 2. In this paper, we write simply ring for commutative ring . As in [3, 23], a ring is required to have a unit element, a ring homomorphism is required to preserve the unit element, and a subring is required to contain the unit element. The ring of integers is denoted by Z,and, for a prime number p, we write Fp for Z/p Z. For a ring R, we write R∗ for the group of units of R, the characteristic char R is the non-negative integer n for which nZ is the kernel of the unique ring homomorphism Z → R, and we write R[X] for the polynomial ring in one variable X over R. An element of R[X] is monic if it has leading coefficient 1, the unit element of R.Let S be a set, and let f , g: S → R be two functions from S to the field R of real numbers such that for all x ∈ S one has g(x) ≥ 0. By the statement f = O(g) we mean that there exists c ∈ R such that for all x ∈ S one has |f (x)| ≤ c·g(x), and by f = ˜O(g) we mean that there exists c ∈ R such that for all x ∈ S one has |f (x)| ≤ g(x) · (log max {3, g (x)})c.We shall often apply this with S equal to a set of inputs to an algorithm, and f (x) equal to the run time of the algorithm when given x. For example, with the notation just introduced one expresses the run time estimates in Theorems 1 and 2 as ˜O((log n)6) and ˜O(D log p), respectively. 5Whenever we assert that a constant with certain properties exists, it will be effectively computable in the sense explained above; this is also valid for the constants implicit in our use of the O- and ˜O-symbols. The same comment, mutatis mutandis , applies to the exis-tence of algorithms. All of the algorithms that we present in this paper are deterministic. 

2. Pseudofields and period systems 

Pseudofields. By a pseudofield we mean a pair ( A, α ) consisting of a ring A and an element 

α ∈ A, such that for some integer n > 1, some integer d > 0, and some ring automorphism 

σ of A, the following conditions are satisfied: (2.1) char A = n, 

(2.2) #A ≤ nd,

(2.3) σα = αn,

(2.4) σdα = α, 

(2.5) σd/l α − α ∈ A∗ for each prime number l dividing d.In Section 5 we shall prove the following result about pseudofields. 

Proposition 2.6. Let (A, α ) be a pseudofield, and let n, d be as above. Then there is a unique monic polynomial f ∈ (Z/n Z)[ X] with the property that there is a ring isomorphism (Z/n Z)[ X]/(f ) ∼= A that maps the coset (X mod f ) to α. In addition, the degree of this polynomial equals d.

The polynomial f from 2.6 and its degree d are called the characteristic polynomial and the degree of the pseudofield, respectively. The proposition implies that each element of A

can in a unique way be written as g(α), where g ∈ (Z/n Z)[ X] satisfies deg g < d . This implies that equality holds in (2.2). It also implies that, as a ring, A is generated by α,so that the automorphism σ of A is uniquely determined by (2.3); we refer to it as the 

Frobenius automorphism of the pseudofield. 

Example. If n ∈ Z, n > 1, and a ∈ Z, then the pair ( Z/n Z, a mod n) is a pseudofield if and only if one has an ≡ a mod n; for composite n, one often expresses this property by saying that n is a pseudoprime to the base a. In this example, the degree equals 1, the Frobenius automorphism is the identity, and the characteristic polynomial is X−(a mod n). 

Example. Let n ∈ Z, n > 1, let r be a positive integer with gcd( r, n ) = 1, and denote by Φ r the rth cyclotomic polynomial. Then the pair ((Z/n Z)[ X]/(Φ r), X mod Φ r

) is a 6pseudofield if and only if n mod r generates the group ( Z/r Z)∗. This pseudofield is closely related to the rings used in [2]. In this example, the degree equals ϕ(r), where ϕ denotes Euler’s function, the Frobenius automorphism maps each ( g mod Φ r) to ( g(Xn) mod Φ r), and Φ r is the characteristic polynomial. Finite fields yield pseudofields, as explained in the following result. 

Proposition 2.7. Let p be a prime number, let A be a ring of characteristic p, and let 

α ∈ A. Then (A, α ) is a pseudofield if and only if A is a finite field satisfying A = Fp(α).In addition, if (A, α ) is a pseudofield, and σ denotes its Frobenius automorphism, then for all β ∈ A one has σβ = βp.

This proposition is proved in Section 5. 

Primality testing with pseudofields. The following result shows that, for the purposes of primality testing, pseudofields can play the role that the rings ( Z/n Z)[ X]/(Xd − 1) play in [2]. 

Proposition 2.8. Let (A, α ) be a pseudofield of degree d with Frobenius automorphism 

σ, and let n = char A. Suppose that for each a = 1 , 2, . . . , ⌊(d/ 3) 1/2(log n)/ log 2 ⌋ one has 

αn + a = ( α + a)n. Suppose also that one has d > (log n)2/(3 · (log 2) 2), and that n has a prime factor greater than (d/ 3) 1/2(log n)/ log 2 . Then n is a power of a prime number. 

The proof of Proposition 2.8 in given in Section 6. 

Algorithmic aspects of pseudofields. Proposition 2.6 shows that a pseudofield is, up to isomorphism, determined by its characteristic n and its characteristic polynomial f . We shall for algorithmic purposes always assume a pseudofield to be specified by the pair ( n, f ), the polynomial f being represented by its vector of coefficients; this applies in particular when a pseudofield forms part of the input or output of an algorithm. The pseudofield represented by ( n, f ) equals ((Z/n Z)[ X]/(f ), X mod f ), and its elements are represented as polynomials in ( Z/n Z)[ X] of degree smaller than the degree d of the pseudofield. It is well-known that there are algorithms that, given n, f , and two elements of ( Z/n Z)[ X]/(f ), compute the sum and the product of these two elements within time ˜O(d log n) (see [7]). As a consequence, testing the equality αn + a = ( α + a)n from 2.8 for a single value of a

in Z/n Z can be done in time ˜O(d(log n)2), and for about ( d/ 3) 1/2(log n)/ log 2 values of 

a in time ˜O((d1/2 log n)3). This time bound will equal the time bound ˜O((log n)6) from Theorem 1 if we use a pseudofield for which the degree d is, as a function of n, not too much larger than the lower bound (log n)2/(3 · (log 2) 2) from 2.8. Thus, we are faced with 7the problem of constructing a pseudofield of given characteristic and approximately given degree. The techniques that we develop for constructing pseudofields culminate in the follow-ing result. Let n ∈ Z, n > 1. By a period pair for n we mean a pair ( r, q ) of integers with the properties (2.9) r is a prime number not dividing n, 

(2.10) q divides r − 1 and q > 1,

(2.11) the multiplicative order of n(r−1) /q modulo r equals q. 

Further, a period system for n is a finite set P of period pairs for n such that (2 .12) gcd( q, q ′) = 1 whenever ( r, q ), (r′, q ′) ∈ P , (r, q ) 6 = ( r′, q ′),

and the degree of P is ∏ 

> (r,q )∈P

q, denoted deg P.

Proposition 2.13. There is an algorithm that, given an integer n with n > 1 and a period system P for n satisfying n > deg P, either correctly declares n composite or constructs a pseudofield of characteristic n and degree deg P, and that runs in time 

˜O

(( 

deg P + ∑

> (r,q )∈P

q(r + log n)

)

log n

)

.

The proof of Proposition 2.13 is given in Section 8. If n is known to be prime, then the algorithm of Proposition 2.13 simplifies somewhat, and the term involving (log n)2 in the run time estimate may be omitted; in view of Proposition 2.7, this leads to the following result. 

Proposition 2.14. There is an algorithm that, given a prime number p and a period system P for p satisfying p > deg P, constructs a monic irreducible polynomial f ∈ Fp[X]

with deg f = deg P, and that runs in time 

˜O

(( 

deg P + ∑

> (r,q )∈P

qr 

)

log p

)

.

The proof of Proposition 2.14 is also given in Section 8. 

The existence of period systems. Our final auxiliary result reads as follows. 8Proposition 2.15. There are effectively computable positive integers c4, c 5 such that, for each integer n > c 4 and each integer D > (log n)46 /25 , there exists a period system P for 

n consisting of pairs (r, q ) with 

(2 .16) r < D 6/11 , q < D 3/11 , q prime ,

and with D ≤ deg P < D + D1−1/(c5 (log log D)2 ). In addition, the number of period systems 

P for n with deg P ∈ [D, 2D) exceeds D/ exp(5(log log D)3).

We use Proposition 2.15 to show that the algorithms of Theorems 1 and 2 perform as stated. In particular the number c4 of Theorem 2 is the same as in 2.15. Proposition 2.15 is proved in Section 13 using a stronger version of Theorem 4 (namely, Proposition 10.1) and using Theorem 5. In particular, we will show in Propositions 13.1 and 13.4 that it is common for primes r of a certain size to have r − 1 divisible by a fairly large prime divisor q with ( r, q ) being a period pair for n. We then use Theorem 5 to show that the primes q appearing in this way are plentiful enough for the hypothesis of Proposition 10.1 to hold, and so construct period systems for n, as in 2.15, with degrees close to a given target degree. 

3. The primality test 

In this section we deduce Theorem 1 from the results stated in Section 2. We begin with a straightforward transformation of 2.15 into an algorithm for constructing period systems. 

Algorithm 3.1. We describe an algorithm that takes as input an integer n > 1 and an integer D > 0, and that searches for a period system P for n consisting of pairs ( r, q )satisfying (2.16) and with deg P not much larger than D.

Step 1. Using a modified version of the sieve of Eratosthenes, sieving with prime powers rather than just with primes, compute the prime factorizations of all integers in [1 , 2D). 

Step 2. For each prime number r < D 6/11 not dividing n, in increasing order, determine the set Q(r) of prime factors q of r − 1 that satisfy 

q < D 3/11 , n(r−1) /q 6 ≡ 1 mod r, q / ∈ ⋃

> r′<r

Q(r′).

Put Q = ⋃ 

> r

Q(r) and, for each q ∈ Q , put rq = r if q ∈ Q (r). 9Step 3. If there is some integer in [ D, 2D) that is squarefree and composed solely of primes from Q, let d be the least such integer, let P be the set of all pairs ( rq , q ), with q

ranging over the prime factors of d, return P and halt. If no such integer exists, pronounce failure and halt. This completes the description of Algorithm 3.1. The constant c4 in the following result is as in 2.15. 

Proposition 3.2. Algorithm 3.1 , when given integers n > 1 and D > 0, successfully computes a period system P for n with the properties listed in (2.16) and with deg P ∈ 

[D, 2D) if and only if such a period system exists, which is the case if n > c 4 and D > 

(log n)46 /25 ; the run time of the algorithm is ˜O(D + D6/11 log n).

Proof. The “if and only if” statement is clear from the algorithm, the second assertion is immediate from 2.15, and proof of the run time estimate is entirely straightforward. This proves 3.2. 

Primality testing. We describe an algorithm that has the properties stated in Theorem 1. We let c4 again be as in 2.15. 

Algorithm 3.3. Given an integer n > 1, this algorithm decides whether or not n is prime. 

Step 1. If n ≤ c4, find by trial division the least prime p dividing n, declare n prime or composite according as n = p or n 6 = p, and halt. 

Step 2. Using the algorithm of [8], determine the largest k ∈ Z for which there exists 

m ∈ Z with n = mk . If k > 1, declare n composite and halt. 

Step 3. Using standard algorithms for computing elementary functions (cf. [7, 12]), compute an integer D satisfying 

D − 2 < max {(log n)2/(3 · (log 2) 2), (log n)46 /25 } < D. 

Next, using Algorithm 3.1, construct a period system P for n with the properties listed in (2.16) and with deg P ∈ [D, 2D). Put d = deg P.

Step 4. Using standard algorithms for computing elementary functions (cf. [7, 12]), compute an integer b satisfying 

b − 1 < (d/ 3) 1/2(log n)/ log 2 < b + 1 ,

and test by trial division whether n has a divisor among 2, 3, . . . , max {d, b }. If it does, let 

p be the least such divisor, declare n prime or composite according as n = p or n 6 = p, and halt. 10 Step 5. Using the algorithm of 2.13, either declare n composite and halt, or construct a pseudofield ( A, α ) of characteristic n and degree d.

Step 6. For a = 1, 2, . . . , b, test the equality αn + a = ( α + a)n in A. If all of these are valid, declare n prime and halt. If at least one fails to be valid, declare n composite and halt. This completes the description of Algorithm 3.3. 

Proof of Theorem 1 . We prove that Algorithm 3.3 has the properties claimed in Theorem 1; that is, it terminates within time ˜O((log n)6), correctly declaring n prime or composite. Step 1 runs in time O(1), and by [8], Step 2 runs in time ˜O(log n). If the algorithm halts during one of these two steps, it is clearly correct. Assume otherwise, so that one has 

n > c 4 and n is not a proper power. The first part of Step 3 runs in time O(log n), and from D > (log n)46 /25 and D = O((log n)2) it follows, by 3.2, that the second part of Step 3 successfully computes a period system in time ˜O((log n)23 /11 ). We have d = O((log n)2),and from d ≥ 2#P one obtains # P = O(log(2 log n)). Step 4 runs in time ˜O((log n)3)

because b = O((log n)2). If the algorithm halts in Step 4, it is clearly correct. Suppose otherwise. Then we have n > d , so by 2.13 and the inequalities in (2.16), Step 5 runs in time ˜O((log n)3). As we argued in Section 2, the test in Step 6 can be done in time ˜O((d1/2 log n)3), which is ˜O((log n)6). Since n passed Step 4, it has a prime divisor greater than ( d/ 3) 1/2(log n)/ log 2, so 2.8 implies that, if n passes the test in Step 6, it is a prime power; not being a proper power, it must be prime. If n does not pass the test in Step 6, then by 2.7 (with n in the role of p and α + a in the role of β) it cannot be a prime number. This concludes the proof of Theorem 1. 

4. Constructing finite fields 

In this section we prove Theorem 2. We begin with two lemmas that are used to deal with certain exceptional cases. 

Lemma 4.1. Let k be a finite field, r a prime number, h a non-negative integer, and 

b ∈ k∗ an element that is not an rth power in k∗. Assume that one has #k ≡ 1 mod 4 if 

rh ≡ 0 mod 4 . Then Xrh

− b is irreducible in k[X].

Proof. See [25, Theorem 3.75]. 

Lemma 4.2. For any non-negative integer h, the polynomials X2·3h

+X3h

+1 and X4·3h

+

X3h

+ 1 are irreducible in F2[X]. For any prime number p with p ≡ 1 mod 4 , any non-negative integer h, and any a ∈ Fp satisfying (a

> p

) = −1, the polynomial X2h

− a is 

11 irreducible in Fp[X]. For any prime number p with p ≡ − 1 mod 4 there exists a ∈ Fp

with (a2 +4 

> p

) = −1, and for any such a and any non-negative integer h the polynomial 

X2h+1 

− aX 2h

− 1 is irreducible in Fp[X].

Proof. In this proof, we denote algebraic closures by an overhead bar. First let p = 2. Let a, α ∈ ¯F2 satisfy a2 + a + 1 = 0 and α3h

= a. Then F2(α) contains 

F2(a), and the latter field has degree 2 over F2. Since the only non-zero cube in F2(a)∗

is 1, one has by 4.1 that [ F2(α)r : F2(a)] = 3 h, and therefore [ F2(α) : F2] = 2 · 3h. Since 

α is a zero of X2·3h

+ X3h

+ 1, this polynomial is irreducible in F2[X]. Now let b, β ∈ ¯F2

satisfy b4 + b + 1 = 0 and β3h

= b. Then F2(β) contains F2(b), a field of degree 4 over F2.The nonzero cubes in F2(b) are roots of X5 − 1, so b is not a cube. Thus, by 4.1 one has [F2(β) : F2(b)] = 3 h and so [ F2(β) : F2] = 4 · 3h. Since β is a root of X4·3h

+ X3h

+ 1, this polynomial is irreducible in F2[X]. Next let p ≡ 1 mod 4. In this case the Lemma is immediate from 4.1. Finally suppose p ≡ − 1 mod 4. If c is the least positive integer with (c

> p

) = −1, then one can write ( c − 1 mod p) = e2 with e ∈ Fp, and a = 2 e then satisfies (a2 +4 

> p

) = (4

> p

) · (c

> p

) = −1. Next let b, α ∈ ¯Fp satisfy b2 − ab − 1 = 0 and α2h

= b. From (a2 +4 

> p

) = −1 it follows that 

X2 − aX − 1 is irreducible in Fp[X], so the field Fp(b), which is a subfield of Fp(α), has degree 2 over Fp. The product of b and its conjugate equals −1, which is not a square in Fp, so b is not a square in Fp(b). Since one also has # Fp(b) = p2 ≡ 1 mod 4, Lemma 4.1 implies [ Fp(α) : Fp(b)] = 2 h and therefore [ Fp(α) : Fp] = 2 h+1 . Since α is a zero of 

X2h+1 

− aX 2h

− 1, the latter polynomial is irreducible in Fp[X]. This proves 4.2. We describe an algorithm that has the properties stated in Theorem 2. 

Algorithm 4.3. Given a prime number p and a positive integer D, this algorithm attempts to construct an irreducible polynomial f ∈ Fp[X] with D ≤ deg f < 2D. We let c4 be as in 2.15. 

Step 1. [This step takes care of the case in which p is too small for 2.14 or for 3.2 to apply.] If D = 1, return f = X and halt. If p = 2, determine the least non-negative integer h with 2 · 3h ≥ D; if 2 · 3h < 2D, return f = X2·3h

+ X3h

+ 1 and halt. Else, return 

f = X4·3h−1

+ X3h−1

+ 1 and halt. If p ≡ 1 mod 4 and p ≤ max {c4, 2D}, determine the least positive integer a with (a

> p

) = −1 and the least non-negative integer h with 2 h ≥ D,return f = X2h

− a and halt. If p ≡ − 1 mod 4 and p ≤ max {c4, 2D}, determine the least 12 positive integer a with (a2 +4 

> p

) = −1 and the least non-negative integer h with 2 h+1 ≥ D,return f = X2h+1 

− aX 2h

− 1 and halt. 

Step 2. [In this case we have p > c 4 and p > 2D.] Apply Algorithm 3.1 to n = p

and D; if that algorithm pronounces failure, pronounce failure and halt. Otherwise, let P

be the period system for p produced by Algorithm 3.1, apply the algorithm of 2.14 to P,return the polynomial produced by the latter algorithm and halt. This completes the description of Algorithm 4.3. Theorem 2 is now an immediate consequence of the following somewhat stronger result. 

Theorem 4.4. Let c4, c 5 be as in 2.15. Algorithm 4.3 , when given a prime number p

and a positive integer D, runs in time ˜O(D log p), and if it does not pronounce failure then it computes a monic irreducible polynomial f ∈ Fp[X] satisfying D ≤ deg f <

2D; in addition, it does not pronounce failure if p ≤ max {c4, 2D} or D > (log p)46 /25 .Further, in the case p > max {c4, 2D} and D > (log p)46 /25 , one has D ≤ deg f < D +

D1−1/(c5(log log D)2 ).

Proof. First suppose p ≤ max {c4, 2D}. Then by 4.2 the algorithm halts in Step 1 and returns a polynomial f that is irreducible over Fp and that satisfies D ≤ deg f < 2D.From p = O(D) one readily deduces that the computation of h in Step 1 and, if p is odd, 

a in Step 1 can be done in time ˜O(D). Next assume p > max {c4, 2D}. If D > (log p)46 /25 ,then by 3.2 the algorithm successfully computes a period system for p, and if it successfully computes a period system, then by 2.14 it computes a polynomial f with the stated properties. The run time estimate for Step 2 is obtained in a routine manner from 3.2 and 2.14; note that the sum ∑ 

> (r,q )∈P

qr occurring in 2.14 is ˜O(D9/11 ), by the inequalities in (2.16). This proves 4.4. 

5. Algebraic properties of pseudofields 

In Section 2 we defined pseudofields, and the present section is devoted to their basic algebraic properties. For a ring A, an element α ∈ A, and a ring automorphism σ of A, we will have occasion to refer to the condition (5 .1) σα belongs to the subring of A generated by α. 

This condition is implied by condition (2.3), if n is a positive integer. 13 Proposition 5.2. Let A be a ring, let α ∈ A, let d ∈ Z>0, and let σ be a ring auto-morphism of A such that (2.4) , (2.5) , and (5.1) are satisfied. Then for any i, j ∈ Z with 

i 6 ≡ j mod d one has σiα − σj α ∈ A∗.

Proof. Let h ∈ Z, h / ∈ dZ, and let I = ( σhα − α) be the A-ideal generated by σhα − α.The set {β ∈ A : σhβ ≡ β mod I} is a subring of A that contains α, so by (5.1) it contains 

σα ; that is, one has σh+1 α ≡ σα mod I, so σ(σhα − α) belongs to I, and therefore one has σI ⊂ I. Since σd maps σhα − α to itself, we actually have σI = I, so for all m ∈ Z

one has σmI = I. It follows that the set H = {m ∈ Z : σmα ≡ α mod I} is a subgroup of Z. It contains d and h, where h / ∈ dZ, so one has H = d′Z where d′ is a divisor of d

with 1 ≤ d′ < d . Choose a prime number l that divides d/d ′. Then d/l ∈ d′Z = H, so 

σd/l α − α ∈ I. Thus, by (2.5) the ideal I contains a unit, and therefore I = A. This implies 

σhα − α ∈ A∗. Now let i, j ∈ Z, i 6 ≡ j mod d. Then the integer i − j does not belong to dZ,so by the result just proved we have σi−j α − α ∈ A∗. Applying σj we find σiα − σj α ∈ A∗,as required. This proves 5.2. 

Lemma 5.3. Let A be a ring, let k ∈ Z≥0, and let α1, α2, . . . , αk ∈ A be such that 

αi − αj ∈ A∗ whenever 1 ≤ i < j ≤ k. Then for each g ∈ A[X] which vanishes at 

α1, α 2, . . . , α k, one has g ∈ A[X] · ∏ki=1 (X − αk).

Proof. Let Ii = A[X] · (X − αi), for 1 ≤ i ≤ k. For i 6 = j, the unit αi − αj can be written as 

−(X − αi) + ( X − αj ), so Ii + Ij = A[X]. This implies ∏ki=1 Ii = ⋂ki=1 Ii, by [3, Proposition 1.10(i)]. From X ≡ αi mod Ii one obtains g ≡ g(αi) mod Ii for each g ∈ A[X], so if each 

g(αi) vanishes then one has g ∈ ⋂ki=1 Ii = ∏ki=1 Ii = A[X] · ∏ki=1 (X − αk), as required. This proves 5.3. The following result summarizes the technical information on pseudofields that we shall need. 

Proposition 5.4. Let A be a ring, let α ∈ A, and let the integers n ∈ Z>0, d ∈ Z>0 and the ring automorphism σ of A satisfy (2.1) , (2.2) , (2.4) , (2.5) , and (5.1) . Then one has: 

(a) for each β ∈ A there are unique a0, a1, . . . , ad−1 ∈ Z/n Z with β = ∑d−1 

> i=0

aiαi;

(b) one has #A = nd, and σd equals the identity; 

(c) the polynomial f = ∏d−1 

> i=0

(X − σiα) belongs to the subring (Z/n Z)[ X] of A[X];

(d) the ring homomorphism (Z/n Z)[ X] → A sending X to α is surjective, and its kernel is generated by the polynomial f from (c) ;

14 (e) if I ⊂ A is an ideal, then one has σI ⊂ I if and only if there exists a divisor m of n

such that I = mA ;

(f) for each prime factor p of n there exists a unique residue class (i mod d) such that for all β ∈ A one has βp ≡ σiβ mod pA .

Proof. It is clear that there is a unique ring homomorphism ψ: ( Z/n Z)[ X] → A as in (d), and that it maps each g ∈ (Z/n Z)[ X] to g(α). If g ∈ ker ψ, then for each i ∈ Z one has 

g(σiα) = σi(g(α)) = σi(ψ(g)) = 0, so by 5.2 and 5.3 one has g ∈ A[X]f , where f is as in (c). Since each non-zero g ∈ A[X]f has degree at least d, this implies ker ψ ∩ ((Z/n Z) + ( Z/n Z)X + . . . + ( Z/n Z)Xd−1) = {0},

so that the restriction of ψ to ( Z/n Z)+( Z/n Z)X+. . . +( Z/n Z)Xd−1 is injective. From (2.2) one now sees that it is surjective as well, which proves (a), the first statement of (b), and the surjectivity in (d). Since each element of A can be expressed in α, the second statement of (b) follows from (2.4). Applying (a) to β = αd, one finds a0, a1, . . . , ad−1 ∈ Z/n Z

for which the polynomial g = Xd − ∑d−1 

> i=0

aiXi belongs to ker ψ; hence g ∈ A[X]f , and comparing degrees and leading coefficients one finds g = f . This implies (c). We have ker ψ = A[X]f ∩ (Z/n Z)[ X] = ( Z/n Z)[ X]f , the latter equality because f is a monic polynomial in ( Z/n Z)[ X]. This proves the remaining assertion of (d). The “if”-part of (e) is clear. For the “only if”-part, let I be an ideal of A with σI ⊂ I,and let ¯A be the ring A/I . From σI ⊂ I it follows that σ induces a ring homomorphism ¯σ: ¯A → ¯A. From (b) one sees that ¯ σd is the identity on ¯A, so ¯ σ is an automorphism of ¯A. Put m = char ¯A. Then m divides n, and we have mA ⊂ I, so from (a) we see # ¯A ≤ #A/mA = md, with equality if and only if mA = I. We claim that (2.1), (2.2), (2.4), (2.5), and (5.1), with ¯A, m, d, ¯ σ, and ¯ α = ( α mod I) in the roles of A, n, d, σ, and 

α, are satisfied. For (2.2) we just proved this, (2.1) is true by definition, and (2.4), (2.5), and (5.1) follow from the corresponding properties of A, n, d, σ, and α. Hence, applying (b) to this new situation, we find # ¯A = md, so that mA = I. This proves (e). To prove (f), we replace, for notational convenience, n and A by p and A/pA , so that we may assume n = p. Let φ: A → A be the ring homomorphism that maps each β ∈ A to 

βp, and let g ∈ (Z/n Z)[ X] be such that σα = g(α). If ρ: A → A is any ring homomorphism with σρ = ρσ , then one has σ(ρα ) = ρ(σα ) = ρ(g(α)) = g(ρα ). Applying this to ρ = φ

and to ρ = σi, where i ∈ Z, we obtain σ(φα ) = g(φα ) and σ(σiα) = g(σiα) and therefore 

σ(φα ) ≡ σ(σiα) mod ( φα −σiα)A. Hence, for any i ∈ Z, the ideal I = ( φα −σiα)A satisfies 15 σI ⊂ I, so by (e) and the fact that n is prime one has I = A or I = nA = 0, so that 

φα − σiα is either a unit or 0. From ∏d−1 

> i=0

(φα − σiα) = f (φα ) = φ(f (α)) = 0 p = 0 we see that not all φα − σiα can be units, so at least one of them is 0. Then one has φα = σiα,so φ = σi by (a). The uniqueness of i mod d follows from 5.2. This proves 5.4. We can now prove two propositions stated in Section 2. 

Proof of Proposition 2.6 . Let the notation and hypotheses be as in 2.6. Since (2.3) implies (5.1), Proposition 5.4 applies. The existence of f as in 2.6 follows from 5.4(d). No two distinct monic polynomials in ( Z/n Z)[ X] generate the same ideal, so f is unique. From 5.4(c) one sees deg f = d. This proves 2.6. 

Proof of Proposition 2.7 . Let p, A, and α be as in 2.7. For the “if”-part, assume that A is a finite field with A = Fp(α). Write d = [ A : Fp] and define σ: A → A by putting σβ = βp

for every β ∈ A. It is a standard property of finite fields that σ is a field automorphism of 

A of order d. Now (2.1)–(2.4) are obvious. If l is a prime number dividing d, then σd/l is not the identity, so by A = Fp(α) we have σd/l α 6 = α; since A is a field, this implies (2.5). To prove the “only if”-part and the last statement of 2.7, assume that ( A, α ) is a pseudofield. Write d for the degree and σ for the Frobenius automorphism. Since p is prime, the map A → A sending each β to βp is a ring homomorphism. It agrees with σ on 

α, so by 5.4(a) on all of A, which is the last statement of 2.7. To prove that A is a field, we let β ∈ A, and we prove that β equals 0 or is a unit. Put I = Aβ . From σβ = βp one sees σI ⊂ I, so by 5.4(e) and the fact that p is prime we have I = A or I = pA = 0. In the first case, β is a unit, in the second case it equals 0. Thus, A is a field. By 5.4(a), it is finite, and one has A = Fp(α). This completes the proof of 2.7. 

6. Primality testing with pseudofields 

In this section we prove 2.8. We begin with an elegant lemma. 

Lemma 6.1. Let R be a ring, and let G be a finite subgroup of R∗ such that for each 

β ∈ G, β 6 = 1 , one has β − 1 ∈ R∗. Then G is cyclic. 

Proof. We may clearly assume R 6 = {0}, so that we can choose a maximal ideal M of R.For each β ∈ G, β 6 = 1, the unit β − 1 does not belong to M , so that β is not in the kernel of the natural group homomorphism R∗ → (R/M )∗. Hence the restriction of the latter map to G is injective, and G is isomorphic to its image in ( R/M )∗. Since any finite subgroup of the multiplicative group of a field is cyclic, this implies 6.1. 16 The reader may enjoy proving 6.1 without using maximal ideals, for example by applying 5.3. Let ( A, α ) be a pseudofield, and denote by n, d, and σ its characteristic, its degree, and its Frobenius automorphism, respectively. We let p be a prime divisor of n, and put 

R = A/pA . We shall simply write α for the image of α in R, and σ for the automorphism of R induced by σ. Note that the conditions of Proposition 5.4, with R, α, p, d, σ in the roles of A, α, n, d, σ, are satisfied. As in the proof of 2.7, we have (6 .2) if β ∈ R satisfies σβ ∈ Rβ, then β = 0 or β ∈ R∗,

by 5.4(e) applied to I = Rβ . We put 

G = {β ∈ R : β 6 = 0 , σβ = βn}.

For any β ∈ G, one has σβ = βn ∈ Rβ , so β ∈ R∗ by (6.2). Since G is finite and closed under multiplication, and contains 1, it is a subgroup of R∗. Also, for any β ∈ G, β 6 = 1, one has σβ = βn ≡ 1 mod R · (β − 1), so σ(β − 1) ∈ R · (β − 1) and β − 1 ∈ R∗, again by (6.2). Thus, Lemma 6.1 implies (6 .3) G is a cyclic subgroup of R∗.

Lemma 6.4. If #G > n 

√d/ 3 − 1, then n is a power of p.

Proof. If n = p the lemma is true, so assume n > p . We let φ be the ring homomorphism 

R → R that sends each β ∈ R to βp. By 5.4(f), this map is a power of σ; in particular, it is an automorphism of R. The definitions of φ and G then imply that for all β ∈ G one has ( σφ −1)β = βn/p .Let L be the kernel of the group homomorphism Z2 → 〈 σ〉 that maps ( i, j ) to (σφ −1)iφj . Since the image 〈σ〉 of the group homomorphism has order d, the group L

is a lattice of determinant d (see [14, Chapter I]). Consider the closed convex symmetric subset 

K = {(x, y ) ∈ R2 : max {| x log( n/p )|, |y log p|, |x log( n/p ) + y log p|} ≤ t}

of R2, where t ∈ R>0 is chosen such that the area 3 · t2/(log( n/p ) · log p) of K equals 4 d.(Note that K is the hexagonal region with vertices at ±(t/ log( n/p ), 0), ±(0 , t/ log p), and 

±(t/ log( n/p ), −t/ log p).) By the inequality of the means we have 

t = 2 √d/ 3 · (log( n/p ) · log p)1/2 ≤ √d/ 3 · log n. 

17 According to Minkowski’s lattice point theorem (see [14, Chapter III, Theorem II]), the set K contains a non-zero element ( i, j ) of L. Multiplying ( i, j ) by ±1, we may assume that i ≥ 0. Note that ( i, j ) ∈ K implies that ( n/p )ipj ≤ n

√d/ 3 in the case that j ≥ 0 and 

∣∣(n/p )i − p−j ∣∣ ≤ max {(n/p )i, p −j } − 1 ≤ n

√d/ 3 − 1in the case that j < 0. From ( σφ −1)iφj = id R we see that for all β ∈ G one has β(n/p )i pj

=

β. By (6.3), we can choose β to be a generator of G. Thus ( n/p )ipj ≡ 1 mod # G in the case that j ≥ 0 and ( n/p )i ≡ p−j mod # G in the case that j < 0. But, by hypothesis, #G > n 

√d/ 3 − 1, so in either case we have ( n/p )ipj = 1. By unique factorization in Z and (i, j ) 6 = (0 , 0), this equation forces n to be a power of p. This concludes the proof of 6.4. 

Proof of Proposition 2.8 . We let the notation and the assumptions be as in Proposition 2.8, and in addition we write B = ⌊(d/ 3) 1/2(log n)/ log 2 ⌋. Note that d > (log n)2/(3 · (log 2) 2)

implies d > B .We apply the theory just developed to a prime factor p of n that satisfies p > B . From 

σα = αn we see that the element α of R = A/pA belongs to the subgroup G of R∗. From 

σ(α + a) = σα + a = αn + a = ( α + a)n for a = 1, 2, . . . , B and from 5.4(a), which implies each α + a 6 = 0, we see that α + 1, α + 2, . . . , α + B also belong to G. For each proper subset S of {0, 1, . . . , B }, the element ∏ 

> a∈S

(α + a) also belongs to G. There are 2 B+1 − 1such sets S, and we claim that they give rise to 2 B+1 − 1 different elements of G. To see this, note that by p > B the polynomials X + a, a = 0, 1, . . . , B, are distinct in Fp[X], and that by unique factorization in Fp[X] the polynomials ∏ 

> a∈S

(X + a), with S as above, are pairwise distinct. By d > B , all these polynomials have degrees smaller than d, so by 5.4(a) (applied to R) they give rise to 2 B+1 − 1 different elements ∏ 

> a∈S

(α + a) of G, as asserted. It follows that we have #G ≥ 2B+1 − 1 > 2(d/ 3) 1/2 (log n)/ log 2 − 1 = n

√d/ 3 − 1.

Applying 6.4 we conclude that n is a power of p. This proves 2.8. 18 7. Tensor products 

Tensor products (see [3, Chapter 2; 23, Chapter XVI]) can be used to construct “large” pseudofields out of “small” ones, in the following manner. 

Proposition 7.1. Let (A1, α 1) and (A2, α 2) be pseudofields with char A1 = char A2 = n,and suppose that the degrees d1, d2 of these pseudofields satisfy d1 > 1, d2 > 1, and 

gcd( d1, d 2) = 1 . Then the tensor product (A1 ⊗Z/n Z A2, α 1 ⊗ α2) is a pseudofield of characteristic n and degree d1d2.

Proof. We check that A = A1 ⊗Z/n Z A2, α = α1 ⊗ α2, n, d = d1d2, and σ = σ1 ⊗ σ2

satisfy (2.1)–(2.5). By 5.4(a), each Ai is a free Z/n Z-module with basis 1, αi, . . . , αdi −1 

> i

,so from [23, Chapter XVI, Corollary 2.4] one sees that A is a free Z/n Z-module with basis (αi

> 1

⊗αj

> 2

)0≤i<d 1 ,0≤j<d 2 . This implies both (2.1) and (2.2). One has σ(α) = σ1(α1)⊗σ2(α2) = 

αn 

> 1

⊗ αn 

> 2

= αn, which is (2.3). Each σdi 

> i

is the identity on Ai, so σd is the identity on A,which implies (2.4). Finally, to prove (2.5), let l be a prime number dividing d. Then l

divides exactly one of d1 and d2; by symmetry we may assume it divides d2. Let k be a prime number dividing d1. By σ1α1 = αn 

> 1

, the A1-ideal A1α1 is mapped to itself by σ1

and therefore contains σd1 /k  

> 1

α1 − α1; the latter element is a unit of A1, so α1 is a unit of A1 as well. Since d/l is divisible by d1, we have σd/l  

> 1

α1 = α1 ∈ A∗

> 1

. Since d/l is not divisible by d2, Proposition 5.1 implies σd/l  

> 2

α2 − α2 ∈ A∗

> 2

. It follows that the element 

σd/l α − α = ( σd/l  

> 1

α1) ⊗ (σd/l  

> 2

α2) − α1 ⊗ α2 = α1 ⊗ (σd/l  

> 2

α2 − α2) is a product of two units, and therefore belongs to A∗. This proves 7.1. We next address the problem of designing an algorithm that, given two pseudofields ( Ai, α i)as in 7.1, computes their tensor product. Here it is assumed, as in Section 2, that a pseu-dofield is specified by its characteristic and its characteristic polynomial. For the general context of our algorithm one may consult [11]. Let R be a commutative ring, let m ∈ Z, m ≥ 0, and write S for the ring R[t]/(tm+1 ), where t denotes a polynomial variable. The elements 1, t, . . . , tm form a basis for S over 

R, in the sense that every element of S has a unique representation of the form ∑mi=0 aiti,with each ai ∈ R. The elements ∑mi=0 aiti with a0 = 0 form the ideal tS of S, and the elements with a0 = 1 form a subgroup of the group S∗ of units of S; we write 1 + tS for this subgroup. We define the maps D: S → tS and L: 1 + tS → tS by 

D

( m∑

> i=0

aiti

)

=

> m

∑

> i=0

ia iti (ai ∈ R),L(u) = D(u) · u−1 (u ∈ 1 + tS ).

19 (The notation reflects that, up to a factor t, the maps D and L are differentiation and logarithmic differentiation, respectively.) One readily verifies that for u, v ∈ S one has 

D(uv ) = uD (v) + vD (u) and that, consequently, L is a group homomorphism from the multiplicative group 1 + tS to the additive group tS . For a monic polynomial g = Xk +

∑ki=1 biXk−i ∈ R[X], we write g♭ for the image of 1 + ∑ki=1 biti in S, which belongs to 1 + tS . Evidently, we have ( gh )♭ = g♭ · h♭ for any two monic polynomials g, h ∈ R[X]. The 

Hadamard product ∗ is the operation defined on S by 

( m∑

> i=0

aiti)

∗

( m∑

> i=0

biti)

=

> m

∑

> i=0

aibiti,

for ai, bi ∈ R.For any ring homomorphism ψ: R1 → R2, the composition of the induced ring ho-momorphism S1 = R1[t]/(tm+1 ) → S2 = R2[t]/(tm+1 ) with D: S2 → tS 2 equals the composition of D: S1 → tS 1 with the induced map tS 1 → tS 2. Similar remarks apply to L,

♭, and ∗.In the following result we use the definitions just given for the ring R = Z/n Z.

Proposition 7.2. Let the hypotheses and notation be as in 7.1 . Moreover, write f1, f2,

f for the characteristic polynomials of the pseudofields (A1, α 1), (A2, α 2), and (A1 ⊗Z/n Z

A2, α 1 ⊗ α2), respectively. Then for any non-negative integer m we have the identity 

L(f ♭) = −L(f ♭ 

> 1

) ∗ L(f ♭ 

> 2

)

in t(Z/n Z)[ t]/(tm+1 ).

Proof . Let the notation A, α, d, σ1, σ2, σ be as in the proof of 7.1. We view A1 and 

A2 as subrings of A, identifying α1 with α1 ⊗ 1 and α2 with 1 ⊗ α2, so that α = α1α2.It suffices to prove the identity in tA [t]/(tm+1 ). From f = ∏d−1 

> i=0

(X − σiα) we obtain 

f ♭ = ∏d−1

> i=0

(1 − (σiα)t). From L(1 − (σiα)t) = −(σiα)t/ (1 − (σiα)t) = − ∑mj=1 (σiα)j tj

we thus obtain 

L(f ♭) = 

> d−1

∑

> i=0

L(1 − (σiα)t) = −

> m

∑

> j=1

(d−1∑

> i=0

(σiα)j )

tj .

Likewise, we have 

L(f ♭ 

> 1

) = −

> m

∑

> j=1

(d1 −1∑

> i=0

(σi

> 1

α1)j

)

tj , L(f ♭ 

> 2

) = −

> m

∑

> j=1

(d2 −1∑

> i=0

(σi

> 2

α2)j

)

tj .

20 Since σiα = ( σi

> 1

α1) · (σi

> 2

α2) and the orders d1 and d2 of σ1 and σ2 are coprime, we have 

> d−1

∑

> i=0

(σiα)j =

(d1 −1∑

> i=0

(σi

> 1

α1)j

)

·

(d2 −1∑

> i=0

(σi

> 2

α2)j

)

for all j ≥ 1. The identity to be proved now follows from the definition of the Hadamard product. This proves 7.2. 

Proposition 7.3. For positive integers n, m , let Sn,m denote the ring (Z/n Z)[ t]/(tm+1 ).

(a) Let n and m be positive integers such that each prime factor of n exceeds m. Then the map L: 1 + tS n,m → tS n,m is a group isomorphism. 

(b) There is an algorithm that, given positive integers n and m, and an element u ∈

1 + tS n,m , computes the element L(u) of tS n,m in time ˜O(m log n).

(c) There is an algorithm that, given integers n > 1, m > 0, and an element s ∈ tS n,m ,either computes a prime factor of n that is at most m or correctly decides that no such prime factor exists, and in the latter case computes the element L−1(s) of 1 + tS n,m ,all in time ˜O(m log n).

Proof. (a) Since each prime factor of n exceeds m, we have i ∈ (Z/n Z)∗ for i = 1, . . . , m, so 

D restricts to a group automorphism of tS n,m . For the same reason, there are well-defined maps log: 1 + tS n,m → tS n,m and exp: tS n,m → 1 + tS n,m with log(1 − x) = −

> m

∑

> i=1

xi/i, exp( x) = 

> m

∑

> i=0

xi/i !for x ∈ tS n,m . It is well known that log and exp are inverse group isomorphisms. An easy computation shows L = D◦log. It follows that L is an isomorphism, with inverse exp ◦D−1.(b) In [7, Section 8] one finds an algorithm that computes L(u) by means of ˜O(m)ring operations in Z/n Z; this particular algorithm does not depend on the condition, in [7, Section 8], that the field Q of rational numbers be contained in the coefficient ring. By [30, Sections 8.3 and 9.1], each ring operation in Z/n Z can be done in time ˜O(log n). (c) We describe an algorithm with the stated properties. Using the extended Euclidean algorithm, see [30, Corollary 11.10], one attempts to compute i−1 ∈ Z/n Z for i = 1, 2, 

. . . , m; this can only fail if among those i a prime factor of n is found, in which case the algorithm halts. Suppose it does not fail. Then one computes D−1(s) directly from the definition of D by means of m multiplications in Z/n Z, and next one uses the algorithm from [7, Section 9] to compute L−1(s) = exp (D−1(s)) using ˜O(m) ring operations in 21 Z/n Z; inspection of this algorithm shows that the condition from [7, Section 9] that Q be contained in the coefficient ring may be replaced by the weaker condition that multiplicative inverses of each of i = 1, 2, . . . , m be available; this condition is satisfied in the present case. This proves 7.3. 

Proposition 7.4. There is an algorithm with the following property. Given an integer n

and two pseudofields of characteristic n and of coprime degrees d1, d2 greater than 1, it either finds a prime factor of n that is at most d1d2 or it constructs the tensor product of the two given pseudofields, and it does so in time ˜O(d1d2 log n).

Proof. The following algorithm has the stated properties. Let f1, f2 be the characteristic polynomials of the two given pseudofields. Put m = d1d2 and S = ( Z/n Z)[ t]/(tm+1 ), and compute f ♭ 

> 1

, f ♭ 

> 2

∈ 1 + tS from the definition of ♭. Next compute L(f ♭ 

> 1

) and L(f ♭ 

> 2

) by means of the algorithm of 7.3(b), and compute L(f ♭ 

> 1

) ∗ L(f ♭ 

> 2

) by d1d2 multiplications in 

Z/n Z. Finally, apply the algorithm of 7.3(c) to s = −L(f ♭ 

> 1

) ∗ L(f ♭ 

> 2

); this either yields a prime factor of n that is at most m = d1d2, or it finds L−1(s) ∈ 1 + tS ; in the latter case, the characteristic polynomial of the tensor product is the unique monic polynomial 

f ∈ (Z/n Z)[ X] of degree d1d2 that satisfies f ♭ = L−1(s). This completes the description of the algorithm. It is correct by 7.2, and 7.3 readily implies that it runs in time ˜O(d1d2 log n). This proves 7.4. 

8. Gaussian periods 

In this section we let n be an integer with n > 1. Let r be a prime number not divid-ing n, and define Φ r = ∑r−1 

> i=0

Xi ∈ (Z/n Z)[ X]. The element ( X mod Φ r) of the ring (Z/n Z)[ X]/(Φ r) is denoted by ζr, and that ring itself by ( Z/n Z)[ ζr]. We have ζrr = 1 6 = ζr,so ζr is an element of ( Z/n Z)[ ζr]∗ of order r. From deg Φ r = r−1 and 1+ ζr +. . . +ζr−1 

> r

= 0 one sees that the elements ζir, 1 ≤ i ≤ r − 1, form a basis for ( Z/n Z)[ ζr] over Z/n Z.For each a ∈ Z, a / ∈ rZ, the ring ( Z/n Z)[ ζr] has a unique automorphism mapping 

ζr to ζar ; we write σa for this automorphism. The set ∆ of all automorphisms of the form 

σa is a group under composition, and the map σa 7 → (a mod r) is a group isomorphism ∆ ∼= F∗ 

> r

. One concludes that ∆ is cyclic of order r − 1, and that the elements τ ζ r, τ ∈ ∆, form a basis for ( Z/n Z)[ ζr] over Z/n Z.Next let q be a positive integer dividing r − 1. Then ∆ q = {τ q : τ ∈ ∆} is a subgroup of index q of ∆. The subset ( Z/n Z)[ ζr]∆q

= {β ∈ (Z/n Z)[ ζr] : ρβ = β for all ρ ∈ ∆q } is 22 a subring of ( Z/n Z)[ ζr]. An element ∑  

> τ∈∆

aτ · τ ζ r, with each aτ ∈ Z/n Z, belongs to this subring if and only if aτ = aτ ρ for all τ ∈ ∆, ρ ∈ ∆q . Hence, if we put ηr,q = ∑ 

> ρ∈∆q

ρζ r,then the elements τ η r,q , with τ ranging over a set of coset representatives for ∆ modulo ∆q , form a basis for ( Z/n Z)[ ζr]∆q

over Z/n Z; in particular, one has #( Z/n Z)[ ζr]∆q

= nq.The elements τ η r,q are called Gaussian periods of degree q and conductor r. For example, we have ηr,r −1 = ζr and ηr, 1 = −1. We write 

fr,q = ∏  

> τ∆q∈∆/∆q

(Y − τ η r,q ).

This is a monic polynomial in Y of degree q with fr,q (ηr,q ) = 0. Its coefficients, which belong to ( Z/n Z)[ ζr], are readily checked to be invariant under all ρ ∈ ∆, so they belong to ( Z/n Z)[ ζr]∆1

= ( Z/n Z) · ηr, 1 = Z/n Z. Thus, one has fr,q ∈ (Z/n Z)[ Y ]. 

Proposition 8.1. Let n ∈ Z, n > 1, let r be a prime number not dividing n, and let q be a divisor of r − 1 with the property that the element (n(r−1) /q mod r) of F∗ 

> r

has order q.Let the notation ζr, σa, ∆, ηr,q , fr,q be as just defined. Then we have: 

(a) if n is prime, then in the ring (Z/n Z)[ ζr] one has ηnr,q = σnηr,q ;

(b) if in the ring (Z/n Z)[ ζr] one has ηnr,q = σnηr,q , then ((Z/n Z)[ ζr]∆q

, η r,q 

) is a pseudo-field of characteristic n and degree q, with characteristic polynomial fr,q .

Proof. To prove (a), suppose that n is prime. Then the map from ( Z/n Z)[ ζr] sending each 

β to βn is a ring homomorphism, and since it agrees with σn on ζr it coincides with σn on all of ( Z/n Z)[ ζr]. This implies (a). To prove (b), we first observe that the kernel of the group homomorphism F∗ 

> r

→ F∗

> r

sending each x to x(r−1) /q equals the subgroup F∗qr of index q of F∗ 

> r

. Hence the condition that ( n(r−1) /q mod r) have order q implies that the coset ( n mod r)F∗qr generates the group 

F∗ 

> r

/F∗qr and, consequently, that the coset σn∆q generates ∆ /∆q .For brevity, write A = ( Z/n Z)[ ζr]∆q

. Define the ring homomorphism φ: ( Z/n Z)[ Y ] →

A by φ(g) = g(ηr,q ). Its image is the subring of A generated by ηr,q . From σnηr,q = ηnr,q 

it follows that that subring is mapped to itself by σn. Since all elements of ∆ q act as the identity on A, and σn∆q generates ∆ /∆q , the subring is mapped to itself by all τ ∈ ∆. Hence, in addition to ηr,q it contains all τ η r,q , so that it is equal to all of A; in other words, 

φ is surjective. The kernel of φ contains the ( Z/n Z)[ Y ]-ideal generated by fr,q , and since both of these ideals have index nq in ( Z/n Z)[ Y ], we must have equality. Thus, φ induces a ring isomorphism ( Z/n Z)[ Y ]/(fr,q ) ∼= A.23 We prove that A, α = ηr,q , n, d = q, and σ equal to the restriction of σn to A, satisfy (2.1)–(2.5). Conditions (2.1)–(2.3) are clearly satisfied, and (2.4) follows from σqn ∈ ∆q .We prove (2.5). Since σn∆q generates the group ∆ /∆q of order q, we may rewrite the definition of fr,q as 

fr,q =

> q−1

∏

> i=0

(Y − σiηr,q ).

It follows that the derivative f ′ 

> r,q

= d fr,q /dY satisfies f ′

> r,q

(ηr,q ) = ∏q−1 

> i=1

(ηr,q − σiηr,q ), so that to prove (2.5) it will suffice to prove f ′

> r,q

(ηr,q ) ∈ A∗.Let p be a prime number dividing n. Taking the isomorphism ( Z/n Z)[ Y ]/(fr,q ) ∼= A

modulo p, we see that the ring Fp[Y ]/(f ), where f = ( fr,q mod p) ∈ Fp[Y ], is isomorphic to a subring of Fp[X]/(g), where g = ∑r−1 

> i=0

Xi. Since g divides Xr − 1, where r is a prime number different from p, one has gcd( g, dg/ dX) = 1 in the ring Fp[X]. From Lemma 8.2, stated and proved below, it follows that one has gcd( f, df / dY ) = 1 in the ring Fp[Y ]. Thus, there are u, v ∈ Fp[Y ] with uf +vdf / dY = 1. Lifting u, v to ( Z/n Z)[ Y ], one obtains 

up, vp, wp ∈ (Z/n Z)[ Y ] such that upfr,q + vpf ′ 

> r,q

= 1 + pw p. Applying φ one gets, for each prime number p dividing n, an identity in A of the form vp(ηr,q )·f ′

> r,q

(ηr,q )−p·wp(ηr,q ) = 1. Take the product over p, repeating the pth identity just as many times as p occurs in n.On the right, we get 1. On the left, the only term that does not have a factor f ′

> r,q

(ηr,q ) is divisible by n and is therefore 0. Hence, 1 is divisible by f ′

> r,q

(ηr,q ) in A, so that the latter element is a unit, as required. The formula we gave for fr,q shows that it is indeed the characteristic polynomial for the pseudofield. 

Lemma 8.2. Let p be a prime number, and let f , g ∈ Fp[X] be non-zero polynomi-als for which the ring Fp[X]/(f ) is isomorphic to a subring of Fp[X]/(g). Suppose also 

gcd( g, dg/ dX) = 1 . Then one has gcd( f, df / dX) = 1 .

Proof. A non-zero polynomial h ∈ Fp[X] satisfies gcd( h, dh/ dX) = 1 if and only if h is squarefree in the ring Fp[X], and if and only if there is no non-zero nilpotent element in the ring Fp[X]/(h). Thus, the lemma follows from the trivial observation that if a ring has no non-zero nilpotent element, then the same is true for a subring. This proves 8.2 and completes the proof of 8.1. We next describe an algorithm that will prove Propositions 2.13 and 2.14. 

Algorithm 8.3. Given an integer n > 1, which may or may not be known to be prime, and a period system P for n satisfying n > deg P, this algorithm attempts to construct a 24 pseudofield of characteristic n and degree deg P.

Step 1. For all ( r, q ) ∈ P in succession, do the following. Compute ηr,q ∈ (Z/n Z)[ ζr]as well as all of its conjugates τ η r,q , and form the product of the q polynomials Y − τ η r,q in the polynomial ring ( Z/n Z)[ ζr][ Y ]; the result is fr,q , which has coefficients in the subring 

Z/n Z of ( Z/n Z)[ ζr]. If n is not known to be prime, compute by an nth powering in the ring (Z/n Z)[ Y ]/(fr,q ) the unique polynomial gr,q ∈ (Z/n Z)[ Y ] satisfying Y n ≡ gr,q mod fr,q 

and deg gr,q < q , and test whether in the ring ( Z/n Z)[ ζr] one has gr,q (ηr,q ) = σnηr,q ; if this test fails, declare n composite and halt. 

Step 2. [If the algorithm arrives at this point then, as we shall prove below, for each (r, q ) ∈ P the pair ( n, f r,q ) specifies a pseudofield.] Applying the algorithm of 7.4 at most #P− 1 times, either find a prime factor of n that is at most deg P, or construct the repeated tensor product of the # P pseudofields specified by the pairs ( n, f r,q ) for ( r, q ) ∈ P . In the former case, declare n composite and halt, and in the latter case return the tensor product computed by the algorithm and halt. This completes the description of Algorithm 8.3. 

Proposition 8.4. Algorithm 8.3 , when given n, P satisfying n > deg P, runs in time 

˜O

(( 

deg P + ∑

> (r,q )∈P

qr 

)

log n

)

or ˜O

(( 

deg P + ∑

> (r,q )∈P

q(r + log n)

)

log n

)

according as n is or is not known to be prime, and either correctly declares n composite or constructs a pseudofield of characteristic n and degree deg P.

Proof. We first prove the correctness of the algorithm. By fr,q (ηr,q ) = 0, the congruence 

Y n ≡ gr,q mod fr,q in Step 1 implies gr,q (ηr,q ) = ηnr,q . Thus, by 8.1(a), the condition 

gr,q (ηr,q ) = σnηr,q is necessary for n to be prime, and the algorithm is correct if it halts in Step 1. If it passes Step 1, then by 8.1(b) there is for each ( r, q ) ∈ P a pseudofield of characteristic n with characteristic polynomial fr,q . Hence by 7.4 the algorithm either constructs the desired tensor product, or it finds a prime factor of n that is at most deg P;in the latter case, n is composite because n > deg P. This proves the correctness of the algorithm. The run time of Step 1 is dominated by the computation of the polynomials fr,q 

and, if n is not known to be prime, the polynomials gr,q and their values at ηr,q . The computation of fr,q , if done by means of Algorithm 10.3 from [30], runs in time ˜O(qr log n). The computation of gr,q involves O(log n) multiplications in the ring ( Z/n Z)[ Y ]/(fr,q ) and 25 can therefore be performed in time ˜O(q · (log n)2). The computation of gr,q (ηr,q ) runs in time ˜O(qr log n). By 7.4, Step 2 runs in time ˜O(log n · deg P). This proves 8.4. Proposition 2.13 is an immediate corollary of 8.4. In addition, if n is prime, then it is not declared composite, so that the algorithm returns a pseudofield; whence by 2.7, this pseudofield is a finite field. Thus, by 2.6, its characteristic polynomial is irreducible in 

Fn[X]. So Proposition 2.14 follows from 8.4 as well. 

9. The continuous Frobenius problem 

In this section we prove Theorem 3 from the Introduction. As mentioned there, our proof is adapted from Bleichenbacher [10]. For any open subset S of the positive reals, let 

M (S) =

∫

> S

dx

x ,

and let S∗ denote the additive semigroup generated by S. We first prove the theorem in the case that S is a finite union of n open intervals, after which the general case will be seen to follow easily. To prove the theorem for the union of n open intervals, we proceed by induction. In particular, the theorem is true vacuously for the case n = 0. Henceforth we shall assume that (9 .1) n ≥ 1 and the theorem holds for the union of n′ open intervals for all 0 ≤ n′ < n. 

Definition 9.2. Let n be a positive integer, let t ∈ (0 , 1], and let a, b ∈ Rn with (9 .3) t ≥ b1 ≥ a1 ≥ · · · ≥ bn ≥ an ≥ 0, b1 > · · · > b n > 0.

Let (9 .4) S(a, b) = 

> n

⋃

> i=1

(ai, b i).

As a union of open intervals, S(a, b) is an open subset of R>0. Let St,n denote the set of such sets S(a, b) ⊂ (0 , t ) such that for each h ∈ (Z≥0)n with hi = 0 whenever ai = bi,(9 .5) either h · b ≤ 1 or 1 ≤ h · a.

26 Lemma 9.6. If S ∈ S t,n , then 1 6 ∈ S∗. Conversely, if S is the union of at most n open intervals in (0 , t ) with 1 6 ∈ S∗, then S ∈ S t,n .

Proof. Suppose S = S(a, b) ∈ S t,n . If 1 ∈ S∗ there are elements s1, . . . , s N ∈ S with sum 1. For 1 ≤ i ≤ n, let hi be the number of these elements sj with sj ∈ (ai, b i). With 

h = ( h1, . . . , h n) we thus have h ∈ (Z≥0)n, hi = 0 whenever ai = bi, and 

h · a < s 1 + · · · + sN = 1 < h · b,

in violation of (9.5). Thus, 1 6 ∈ S∗. Conversely, suppose that S is the union of at most n

open intervals in (0 , t ). We may write any such S as in (9.3) and (9.4). Assume that there is some h ∈ (Z≥0)n for which hi = 0 whenever ai = bi and (9.5) fails; that is, h·a < 1 < h·b.Let A = h · a, B = h · b, α = ( B − 1) /(B − A), β = (1 − A)/(B − A). Then α, β are positive with α + β = 1. For 1 ≤ i ≤ n, let ci = αa i + βb i. Then, if hi 6 = 0, we have ci ∈ (ai, b i), so that h · c ∈ S∗. But, by construction, we have 

h · c = αh · a + βh · b = αA + βB = 1 ,

so that 1 ∈ S∗. This completes the proof of the lemma. 

Lemma 9.7. Fix an arbitrary vector b = ( b1, b 2, . . . , b n) ∈ Rn for which t ≥ b1 > · · · >bn > 0. Then M (S(a, b)) achieves a maximum value Mb over all a ∈ Rn for which 

S(a, b) ∈ S t,n . Furthermore, Mb > 0.

Proof. Note that by (9.3) and (9.5), the set of vectors a with S(a, b) ∈ S t,n is a compact subset of Rn. Moreover, if a is in this set, we have an 6 = 0 since otherwise 1 ∈ S(a, b)∗,so that Lemma 9.6 implies that S(a, b) 6 ∈ S t,n . Thus, M (S(a, b)) is continuously defined over this set. There are vectors a with S(a, b) ∈ S t,n , indeed a = b is permitted. It follows that M (S(a, b)) attains a maximum Mb as claimed. To see that Mb > 0, let m be the least integer with m > 1/b 1, and then choose a1 = 1 /m and ai = bi for 2 ≤ i ≤ n. The vector a satisfies (9.3) and since 1 6 ∈ S(a, b)∗, Lemma 9.6 implies that S(a, b) ∈ S t,n . But 

M (S(a, b)) = log( mb 1) and this expression is positive since mb 1 > 1. This completes the proof of the lemma. 

Definition 9.8. Let a, b ∈ Rn as in (9.3). We say S(a, b) is degenerate if either ai = bi

for some i with 1 ≤ i ≤ n or ai−1 = bi for some i with 2 ≤ i ≤ n.27 Lemma 9.9. Suppose b satisfies the hypothesis of Lemma 9.7. If S(a, b) ∈ S t,n is such that M (S(a, b)) = Mb, then either Mb < t or S(a, b) is non-degenerate. 

Proof. Suppose S = S(a, b) ∈ S t,n has M (S(a, b)) = Mb. First, we delete each empty interval, that is, each interval with ai = bi. This preserves the property 1 6 ∈ S∗ and does not change M (S). However, it does allow us to reduce to some n′ < n , and by (9.1), 

M (S) < t . Next, suppose that ai−1 = bi for some i with 2 ≤ i ≤ n. We may then consolidate the two intervals ( ai, b i), (ai−1, b i−1) into one interval ( ai, b i−1) keeping the property that 1 6 ∈ S∗ and not changing the value of M (S). Indeed the latter claim is clear, and if 1 is now representable by a sum of members of S ∪ { bi}, then bi must be involved in the sum, say with positive integral coefficient d. If d = 1, then replace bi in the sum with bi + ǫ, for a suitably small ǫ > 0, and then replace another member x ∈ S of the sum with x − ǫ. (There must be another number in the sum since bi < 1.) If ǫ is small enough, both bi + ǫ and x − ǫ are in S, and we have represented 1 as a sum of members of 

S, contradicting S ∈ S t,n (see Lemma 9.6). If d ≥ 2, then since bi + ǫ/ (d − 1) and bi − ǫ

are both in S for ǫ small enough, we can replace the d copies of bi in the sum with d − 1copies of bi + ǫ/ (d − 1) and one copy of bi − ǫ, and so represent 1 as a sum of members of S. Either way, we reach a contradiction, and so the consolidation of the two abutting intervals continues to enjoy the property that 1 is not in the additive semigroup generated by the intervals. Again, by (9.1), we have M (S) < t . We conclude that either M (S) < t or 

S is non-degenerate, proving the lemma. We now assume that the vectors a, b satisfy (9 .10) S(a, b) ∈ S t,n , M (S(a, b)) = Mb,

and (9 .11) t ≥ b1 > a 1 > · · · > b n > a n > 0.

We partition the vectors h ∈ (Z≥0)n into 3 disjoint sets. Let 

H0 = {h ∈ (Z≥0)n : h · a < 1},H1 = {h ∈ (Z≥0)n : h · a = 1 },H2 = {h ∈ (Z≥0)n : h · a > 1}.

Since each ai > 0, it follows that H0, H 1 are finite sets. 28 Lemma 9.12. Let a, b be as in (9.10), (9.11) and for notational convenience, let an+1 =

bn+1 = 0 . If h ∈ H1, then 

hk h · (b − a) ≤ hk(bk − bk+1 ) for 1 ≤ k ≤ n. 

Proof. Let ek be the k-th standard basis vector in Rn. For k = 1 , . . . , n , since h · a = 1 and ak > a k+1 , we have 

h · a − ak + ak+1 < 1.

Suppose that hk > 0. Let h′ = h − ek + ek+1 in the case that k < n , and let h′ = h − ek in the case that k = n. Then h′ ∈ H0. Hence, since (9.5) holds for h′, we have that h′ · b ≤ 1. That is, 

h · b − bk + bk+1 ≤ 1.

Using that h ∈ H1 we get that 

h · (b − a) = h · b − 1 ≤ bk − bk+1 .

Thus, we have 

hk h · (b − a) ≤ hk(bk − bk+1 ),

an inequality that continues to hold if hk = 0. This completes the proof. Let v be an arbitrary vector in Rn and for real numbers x, let 

fv(x) = M

( n⋃

> i=1

(ai + xv i, b i)

)

.

Note that (9 .13) f ′

> v

(0) = −v · m(a),

where m(a) := (1 /a 1, . . . , 1/a n). 

Lemma 9.14. Let v ∈ Rn be such that h · v ≥ 0 for all h ∈ H1. Let ǫv > 0 be a real number such that ai + ǫv < b i for i = 1 , . . . , n . Then for each real number x in [0 , ǫ v], the vector a + xv satisfies (9.11) in place of a. Further, by possibly reducing ǫv > 0, one has 

S(a + xv, b) ∈ S t,n for every real number x ∈ [0 , ǫ v]. In addition, v · m(a) ≥ 0.

Proof. Assume that v ∈ Rn has h · v > 0 for all h ∈ H1 and that ǫv has been chosen as described. It is clear that a + xv satisfies (9.11) for each x ∈ [0 , ǫ v]. Suppose that 29 h ∈ (Z≥0)n, so that h ∈ H0, H 1, or H2. If h ∈ H0, since (9.5) holds for a, we have 

h · b ≤ 1. Thus, (9.5) holds for all of the vectors a + xv and all h ∈ H0. Now suppose 

h ∈ H1. By hypothesis, h · (a + xv) = 1 + xh · v ≥ 1 for all x ∈ R≥0, so that (9.5) holds for each a + xv and all h ∈ H1. Finally we consider H2. Since a ∈ Rn>0, there is a finite “minimal” set H∗ 

> 2

⊂ H2 such that h ∈ H2 if and only if there is some h∗ ∈ H∗ 

> 2

with 

h − h∗ ∈ Zn

> ≥0

. Let 

W = {w ∈ Rn>0 : w · h∗ > 1 for all h∗ ∈ H∗ 

> 2

}.

Then W is an open set that contains a. Thus, given v, by possibly reducing ǫv > 0, for all 0 ≤ x ≤ ǫv we have a + xv ∈ W . It follows that h · (a + xv) > 1 for 0 ≤ x ≤ ǫv and all 

h ∈ H2. That is, (9.5) holds for the vectors a+xv and all h ∈ H2. Thus, S(a+xv, b) ∈ S t,n 

as asserted. By the maximality of a, we have f ′

> v

(0) ≤ 0, which implies the last assertion by (9.13). This completes the proof. It is now clear that H1 is nonempty, since if H1 = ∅, we would have v · m(a) ≥ 0 for all vectors v ∈ Rn, which is patently false. Let r = # H1.We cite a result of Farkas [20]. 

Lemma 9.15. (J. Farkas) Suppose A is an r × n real matrix and m ∈ Rn. Suppose that for all v ∈ Rn with Av ∈ (R≥0)r we have that m·v ≥ 0. Then there is a vector p ∈ (R≥0)r

with pT A = m.

(Note that the converse trivially holds: If Av, p ∈ (R≥0)r and pT A = m, then m · v =

pT A · v = pT · Av ≥ 0.) 

Proof of Theorem 3. We apply Lemma 9.15 to the matrix A whose rows are the r vectors in 

H1 and to the vector m = m(a). We have shown in Lemma 9.14 that Av ∈ (R≥0)r implies that m · v ≥ 0. Thus, Lemma 9.15 implies there is a vector p ∈ (R≥0)r with pT A = m.Say p = ( p1, . . . , p r), H1 = {h1, . . . , hr}, and let each hj = ( hj1, . . . , h jn ). We have 

> r

∑

> j=1

pj hjk = 1/a k for 1 ≤ k ≤ n. 

Take the inequality in Lemma 9.12 applied to hj , multiply it by pj , and sum over j. For 

k = 1 , . . . , n , we have, 

> r

∑

> j=1

pj hjk n∑

> i=1

hji (bi − ai) ≤

> r

∑

> j=1

pj hjk (bk − bk+1 ) = (1 /a k)( bk − bk+1 ).

30 Multiplying corresponding inequalities by ak and summing over k, we get (9 .16) 

> n

∑

> k=1

akr∑

> j=1

pj hjk n∑

> i=1

hji (bi − ai) ≤

> n

∑

> k=1

(bk − bk+1 ) = b1.

The left side of (9.16) is 

> r

∑

> j=1

pjn∑

> k=1

akhjk n∑

> i=1

hji (bi − ai) =

> r

∑

> j=1

pj (hj · a)( hj · (b − a)) =

> r

∑

> j=1

pj hj · (b − a)= m(a) · (b − a) =

> n

∑

> i=1

(bi − ai)/a i.

Thus, (9.16) implies that (9 .17) 

> n

∑

> i=1

(bi/a i − 1) =

> n

∑

> i=1

(bi − ai)/a i ≤ b1.

However, M (( ai, b i)) = log( bi/a i) < b i/a i − 1. Hence, by (9.17), 

Mb =

> n

∑

> i=1

log( bi/a i) < b1 ≤ t. 

We have Mb < t for each choice of b satisfying (9.11), and so Theorem 3 holds for any S which is the union of finitely many intervals. If S ⊂ (0 , t ) is the union of infinitely many disjoint open intervals and has 1 6 ∈ S∗, let S(n) be the union of n of these intervals with S(n) ⊂ S(n + 1) and ⋃ S(n) = S. We have M (S(n)) < t for each n, and so 

M (S) = lim n→∞ M (S(n)) ≤ t. This concludes the proof of the theorem. 

Remarks . We have seen that the inequality M (S) < t holds when S ⊂ (0 , t ) is a finite union of open intervals with 1 not in the additive semigroup generated by S. This inequality for a finite union of intervals is best possible. Indeed, suppose S is the intersection in (0 , t ) of the additive semigroup generated by (1 /(n + 1) , 1/n ), where n is a positive integer. Note that 1 is not in this semigroup. Further, we have 

M (S) ≥

> ⌊tn ⌋

∑

> j=1

M

(( j

n + 1 , j

n

)) 

=

> ⌊tn ⌋

∑

> j=1

log(1 + 1 /n ) > ⌊tn ⌋

( 1

n − 1

n2

)

> t − 1 + t

n .

Thus, as n grows, we have M (S) as close as we please to t.It is possibly true that M (S) < t continues to hold when S is an infinite union of disjoint intervals; that is, the theorem holds with a strict inequality. We leave this as an open question. 31 10. A number-theoretic application 

In this section we give a number-theoretic application to the continuous Frobenius problem, proving a result which contains Theorem 4. The recent paper [21] contains a similar result. 

Proposition 10.1. Let α, ǫ be real numbers with 

0 < ǫ ≤ α/ 2 ≤ 1/4.

There is a positive integer x0 = x0(α, ǫ ), effectively computable if α, ǫ are rational, with the following property. If x, u, D are real numbers with 

x > x 0, 2 < u < (log x)1/10 , and x1/(2( α−ǫ)) ≤ D ≤ x1/α ,

then for any set Q of primes contained in (x1/u , x 1/2] with 

∑

> q∈Q

1

q ≥ α, 

there is a squarefree integer d composed of primes from Q with D ≤ d < D + D1−α/ (4 u).Moreover, the number of squarefree integers d ∈ [D, 2D) composed of primes from Q

exceeds D/ (log D)5u.

Before commencing on the proof we identify some auxiliary variables and prove some lemmas. Let D be as in 10.1 and write 

D = x1/(2( α−δ)) , α/ 2 ≥ δ ≥ ǫ. 

Let N be an integer for which (10 .2) 6u log x ≤ N ≤ x1/(3 u).

For N satisfying (10.2) and for i = 1 , 2, . . . , N , let 

Ii = [x(i−1) /N , x i/N ), Mi = xi/N /i 2.

Further, for Q as in 10.1, let (10 .3) Qi =

{ Ii ∩ Q , if #( Ii ∩ Q ) > M i

∅, otherwise. We remark that Qi = ∅ for i ≤ N/u .32 Lemma 10.4. If x is sufficiently large we have for Q as in 10 .1, N satisfying (10 .2) , and sets Qi defined in (10 .3) ,

> N

∑

> i=1

∑

> q∈Q i

1

q > α − δ/ 2.

Proof. The double sum here is smaller than the sum ∑  

> q∈Q 1
> q

in 10.1, the difference between them coming from intervals Ii with #( Ii ∩ Q ) ≤ Mi. Since Ii ∩ Q = ∅ for i ≤ N/u , the sum of 1 /q for primes q in intervals Ii with #( Ii ∩ Q ) ≤ Mi is at most 

∑

> N≥i>N/u

Mi

x(i−1) /N = ∑

> N≥i>N/u

x1/N 

i2 < 2u

N x1/N ≤ 1

3 log x e1/(6 u) < 1

log x ,

by the first inequality in (10.2). Thus, these primes give a negligible contribution as x → ∞ ,and we have 10.4. For N as in (10.2) and for i = 1 , 2, . . . , N , write xi/N = x(i−1) /N + Li. Then by the upper bound in (10.2), for for all i > N/u ,(10 .5) Li = x(i−1) /N (

x1/N − 1

)

> x (i−1) /N log x

N >

(

x(i−1) /N )3/5

for all sufficiently large x.

Lemma 10.6. We suppose that N satisfies (10 .2) and sets Qi are as in (10 .3) . For each i

with Qi 6 = ∅, let S(i) be the image of Ii under the natural logarithm map, and if Qi = ∅,let S(i) = ∅. If x is sufficiently large, then 

> N

∑

> i=1

∫

> S(i)

dt

t > α − δ. 

Proof. If Qi 6 = ∅, we have i > N/u , and so we may assume that (10.5) holds. The interval 

Ii is thus of the shape [ z, z + L) where L > z 3/5. So, by a theorem of Huxley [22], the number of primes in Ii is (1 + o(1)) Li/ log( x(i−1) /N ) = (1 + o(1)) x(i−1) /N /i as x → ∞ ,uniformly in i for N/u < i ≤ N . Let η = ( δ/ 2) /(δ − α). It follows that for all sufficiently large x and for each i with Qi 6 = ∅, we have that the number of primes in Ii is smaller than (1 + η)x(i−1) /N /i and so (10 .7) ∑

> q∈Q i

1

q < 1 + η

i < (1 + η) log i

i − 1 = (1 + η)

∫

> S(i)

dt

t .

33 Hence, for sufficiently large x, 10.4 and (10.7) imply that 

> N

∑

> i=1

∫

> S(i)

dt

t > (1 + η)−1

> N

∑

> i=1

∑

> q∈Q i

1

q > α − δ/ 2

1 + η = α − δ. 

This proves 10.6. 

Proof of Proposition 10.1. We choose as a target for our squarefree number d a number 

D′ slightly above D, since we may miss the target on the low side, and we wish to have 

d ≥ D. To be specific, let D′ = D exp(2 u(log x)/(αN )) and let S be the additive semigroup generated by 

> N

⋃

> i=1

1

log D′ S(i),

where S(i) is as in 10.6. Note that if S(i) 6 = ∅ we have x(i−1) /N ≤ x1/2, so that using 

D = x1/(2( α−δ)) ,log( xi/N )

log D′ ≤

( 1

2 + 1

N

) log x

log D′ =

( 1

2 + 1

N

) α − δ 

> 1
> 2

+ 2u 

> αN

(α − δ) < α − δ, 

where we used for the last step that α − δ > α/ 2 and u > 2. Thus, S(i)/ log D′ ⊂ (0 , α − δ). It now follows from 10.6 and the fact that the intervals S(i) are disjoint, that 

∫

> S∩(0 ,α −δ)

dt

t ≥

> N

∑

> i=1

∫  

> S(i)/log D′

dt

t = ∑

> i

∫

> S(i)

dt

t > α − δ. 

From Theorem 3 we have that 1 ∈ S. Hence, there is a finite subset F of ⋃ 

> i

S(i) and positive integers κ(f ) for each f ∈ F such that 

∑ 

> f∈F

κ(f )f = log D′.

Let Fi = F ∩ S(i) for i = 1 , 2, . . . , N , and let 

κi = ∑ 

> f∈Fi

κ(f ).

Then, using S(i) = ∅ for i ≤ N/u from 10.3, (10 .8) 

> N

∑

> i=1

κi = ∑

> i

∑ 

> f∈Fi

κ(f ) ≤ ∑

> i

1

log( x(i−1) /N )

∑ 

> f∈Fi

κ(f )f< 1

log (x1/u −1/N ) ∑ 

> f∈F

κ(f )f = log D′

(1 /u − 1/N ) log x < 2u/α, 

34 the last inequality holding when x is sufficiently large. If S(i) 6 = ∅, then (10.2), (10.3) imply that # Qi > M i > x 1/u /N 2 > 2u/α > κ i, again using that x is large. Thus, for each i with 

κi > 0 there are at least κi distinct primes in the set Qi. Label a choice for such primes 

q1,i , q 2,i , . . . , q κi,i and let 

d =

> N

∏

> i=1
> κi

∏

> j=1

qj,i .

We have (10 .9) 

| log D′ − log d| =

∣∣∣∣∣∑ 

> f∈F

κ(f )f −

> N

∑

> i=1
> κi

∑

> j=1

log( qj,i )

∣∣∣∣∣ =

∣∣∣∣∣

> N

∑

> i=1

( ∑ 

> f∈Fi

κ(f )f −

> κi

∑

> j=1

log( qj,i )

)∣ ∣∣∣∣

< ∑

> i

κi

(

log( xi/N ) − log( x(i−1) /N )

)

= log x

N

∑

> i

κi < 2u log x

αN ,

using (10.8). Thus, 

D = D′ exp( −2u(log x)/(αN )) < d < D ′ exp(2 u(log x)/(αN )) < D (1 + 6 u(log x)/(αN )) .

By choosing N near the upper end of the interval in (10.2), we have the first assertion in 10.1. Now we show that there are many squarefree integers in [ D, 2D) that are composed of primes from Q. We choose N = ⌈6u log x⌉ in (10.2) and we let D′ = √2D. For each i

with κi > 0 choose κi primes from Qi and let d denote the product of all of these primes over all choices for i. Then, as in (10.9) and by our choice of N ,

| log D′ − log d| < 2u log x

N < 1

2 log 2 for x large, so that D < d < 2D. It remains to count the number of choices for d in the argument. Since # Qi > M i when κi > 0, the number of choices for d is at least 

∏

> i:κi>0

(⌈Mi⌉

κi

)

≥ ∏

> i:κi>0

( Mi

κi

)κi

= ∏

> i

( xi/N 

i2κi

)κi

> D

∏

> i

(i2κi)κi

.

Now, by (10.8), ∏

> i:κi>0

i2κi < N 2 ∑  

> iκi

< N 4u

35 and 

∏

> i:κi>0

κκi 

> i

<

(∑

> i

κi

)∑ 

> iκi

< (2 u)2u.

Thus, the number of choices for d exceeds D/ (2 uN 2)2u and it remains to note that (2 uN 2)2u < (log x)5u ≤ (log D)5u

for x large. This completes the proof of 10.1. 

11. The distribution of primes in residue classes 

For a positive integer q, an integer a coprime to q, and a real number x, let π(x, q, a ) denote the number of primes p ≤ x with p ≡ a mod q. Also, let 

ψ(x, q, a ) = ∑  

> n≤xn≡amod q

Λ( n), θ(x, q, a ) = ∑   

> p≤x, p prime
> p≡amod q

log p, 

where Λ is von Mangoldt’s function. For fixed q and a coprime to q, we have the asymptotic relations 

π(x, q, a ) ∼ li( x)

ϕ(q) , ψ(x, q, a ) ∼ x

ϕ(q)as x → ∞ , where error estimates may be explicitly calculated. In fact the same remains true if q is allowed to tend to infinity slowly with x, say q < (log x)2−ǫ for fixed ǫ > 0. For 

q > (log x)2 we have either inequalities or ineffective asymptotic estimates. In this section we record some effective inequalities for π(x, q, a ) that are valid in large ranges for q.

Lemma 11.1. [Brun–Titchmarsh inequality] If x > q we have 

π(x, q, a ) ≤ 2x

ϕ(q) log( x/q ) .

The lemma in this form is due to Montgomery and Vaughan [26]. Note that the inequality gives an upper bound for π(x, q, a ) that is of the expected order of magnitude, namely 

x/ (ϕ(q) log x), if q < x 1−ǫ. When q is of order of magnitude xα, the upper bound provided by the lemma is presumably too large by a factor 2 /(1 − α). A result similar to the following lemma, but with a somewhat weaker error estimate, can be found in Timofeev [29, Theorem 2]. 36 Lemma 11.2. [effective Bombieri–Vinogradov inequality] There are absolute, effectively computable positive numbers c6, c 7 such that for all numbers x ≥ 3, there is an integer 

s(x) ∈ [(log x)1/2, exp ((log x)1/2)], such that for each number Q ∈ [x1/3 log x, x 1/2],

∑  

> q≤Qs(x)6|q

max  

> 2≤y≤x

max 

> gcd( a,q )=1

∣∣∣∣ψ(y, q, a ) − y

ϕ(q)

∣∣∣∣ ≤ c6x1/2Q(log x)5 + c6x exp 

(

−c7(log x)1/2

)

.

Proof . We follow Vaughan’s proof of Bombieri’s theorem, see Davenport [15, Chapter 28]. There is an effectively computable positive number c8 such that for any number X > 2, there is at most one integer s1 ≤ X for which there is a primitive (real) character χ1

with modulus s1, and for which the L-function L(z, χ 1) has a real zero β1 > 1 − c8/ log X.Further, if s1 exists, it is at least log X. If s1 exists for X = exp ((log x)1/2), we let s(x) = s1

and if s1 does not exist, we let s(x) = ⌊exp ((log x)1/2)⌋ . Thus, s(x) is an integer in the interval ((log x)1/2, exp((log x)1/2)]. For a Dirichlet character χ to the modulus q, let 

ψ(y, χ ) = ∑

> n≤y

Λ( n)χ(n).

Also, let δ(χ) = 1 if χ is the principal character, and otherwise let δ(χ) = 0. We consider 

|ψ(y, χ ) − δ(χ)y| for q ≤ exp ((log x)1/2), q not divisible by s(x), and 2 ≤ y ≤ x. Any real zero of the L-function L(z, χ ) must be at most 1 − c8/(log x)1/2. We have 

|ψ(y, χ ) − δ(χ)y| = O

(

y1−c8/(log x)1/2

+ y1−c9/(log y)1/2 )

,

where c9 is positive and effectively computable. Indeed, this follows from the prime number theorem if χ is principal, and otherwise it is [15, Chapter 20, (8)]. Thus, uniformly for 

q ≤ exp ((log x)1/2) with q not divisible by s(x), if χ has modulus q, then (11 .3) max  

> 2≤y≤x

|ψ(y, χ ) − δ(χ)y| = O

(

x exp 

(

−c10 (log x)1/2

)) 

,

where c10 = min {c8, c 9}.Consider the elementary identity 

ψ(y, q, a ) − y

ϕ(q) = 1

ϕ(q)

∑  

> χmod q

¯χ(a)( ψ(y, χ ) − δ(χ)y),

37 so that 

E(x, q ) := max  

> 2≤y≤x

max 

> gcd( a,q )=1

∣∣∣∣ψ(y; q, a ) − y

ϕ(q)

∣∣∣∣ ≤ 1

ϕ(q)

∑  

> χmod q

max  

> 2≤y≤x

|ψ(y, χ ) − δ(χ)y|.

Let χ1 be the primitive character that induces χ mod q. Then for q ≤ x,

|ψ(y, χ ) − ψ(y, χ 1)| ≤ ∑

> m≤y
> gcd( m,q )>1

Λ( m) ≤ (log y) ∑ 

> p|qpprime

1 = O ((log x)2) .

Thus, 

E(x, q ) = O

(log x)2 + 1

ϕ(q)

∑  

> χmod q

max  

> 2≤y≤x

|ψ(y, χ 1) − δ(χ1)y|

 .

With ∗ indicating a sum over primitive characters, we have for any number 2 ≤ Q ≤ x

that ∑

> q≤Q

1

ϕ(q)

∑  

> χmod q

max  

> 2≤y≤x

|ψ(y, χ 1) − δ(χ1)y|

= ∑ 

> q1≤Q

∑  

> χ1mod q1
> ∗

max  

> 2≤y≤x

|ψ(y, χ 1) − δ(χ1)y| ∑

> k≤Q/q 1

1

ϕ(kq 1)= O

(log Q) ∑

> q1≤Q

1

ϕ(q1)

∑  

> χ1mod q1
> ∗

max  

> 2≤y≤x

|ψ(y, χ 1) − δ(χ1)y|

 .

For the last step, we used ϕ(kq 1) ≥ ϕ(k)ϕ(q1) and the estimate (11 .4) 

∑

> k≤Q

1

ϕ(k) = ∑

> k≤Q

1

k

∑ 

> u|kusquarefree

1

ϕ(u) = ∑ 

> u≤Qusquarefree

1

ϕ(u)

∑

> ul ≤Q

1

ul = O

∑

> l≤Q

1

l

 = O(log Q).

Dropping the subscripts on χ and q, we thus have uniformly and effectively for real numbers 

Q with 2 ≤ Q ≤ x,(11 .5) ∑

> q≤Q

E(x, q ) = O

Q(log x)2 + (log x) ∑

> q≤Q

1

ϕ(q)

∑  

> χmod q
> ∗

max  

> 2≤y≤x

|ψ(y, χ ) − δ(χ)y|

 .

Let c11 = min {1, c 10 /2} and let Q1 = exp (c11 (log x)1/2). We use (11.3) to estimate the double sum in (11.5) where we restrict to those q not divisible by s(x), getting (11 .6) 

∑  

> q≤Q1
> s(x)6|q

1

ϕ(q)

∑  

> χmod q
> ∗

max  

> 2≤y≤x

|ψ(y, χ ) − δ(χ)y| = O

(

xQ 1 exp 

(

−c10 (log x)1/2)) 

= O(x/Q 1).

38 We now state a consequence of Vaughan’s inequality, see [15, Chapter 28, (2)]: For 1 ≤ Q ≤ x,

∑

> q≤Q

q

ϕ(q)

∑  

> χmod q
> ∗

max  

> 2≤y≤x

|ψ(y, χ )| = O

(

x + x5/6Q + x1/2Q2)

(log x)4.

We apply this for real numbers U with 1 ≤ U ≤ x/ 2, getting 

∑

> U<q ≤2U

1

ϕ(q)

∑  

> χmod q
> ∗

max  

> 2≤y≤x

|ψ(y, χ )| = O

(( 

x/U + x5/6 + x1/2U

)

(log x)4)

.

By breaking ( Q1, Q ] into dyadic intervals ( U, 2U ] and using the inequality for each one, we obtain 

∑ 

> Q1<q ≤Q

1

ϕ(q)

∑  

> χmod q
> ∗

max  

> 2≤y≤x

|ψ(y, χ )| = O

(( x

Q1

+ x5/6 log x + x1/2Q

)

(log x)4

)

,

where there is no restriction on the divisibility of q by s(x). Note that since q > 1 in the sum, any primitive χ mod q is nonprincipal, so that δ(χ) = 0. Putting this estimate together with (11.5) and (11.6), we have 

∑  

> q≤Qs(x)6|q

E(x, q ) = O

(

x1/2Q(log x)5 + x exp 

(

−c7(log x)1/2)) 

for any choice of c7 with c7 < c 11 . This completes the proof of 11.2. 

Lemma 11.7. With the same notation and hypotheses as in 11 .2, we have 

∑  

> q≤Qs(x)6|q

max 

> gcd( a,q )=1

∣∣∣∣π(x, q, a ) − li( x)

ϕ(q)

∣∣∣∣ ≤ c12 x1/2Q(log x)5 + c12 x exp 

(

−c7(log x)1/2)

,

where c7 is as in 11 .2, and c12 is an absolute, effectively computable number. 

Proof . First note that one may replace the expressions ψ(y, q, a ) in 11.2 with θ(y, q, a ), since 

|ψ(y, q, a ) − θ(y, q, a )| ≤ ∑ 

> n≤ynis a power

log y = O

(

y1/2 log y

)

.

Thus, the result follows directly from 11.2 and the identity 

π(x, q, a ) = θ(x, q, a )

log x +

∫ x

> 2

θ(y, q, a )

y(log y)2 dy. 

In fact, one can save a factor of log x using this identity, but this is unimportant. 39 Lemma 11.8. [Deshouillers–Iwaniec] There are effectively computable positive numbers 

c13 , c 14 such that for each integer m with m ≥ 3 there is an effectively computable integer 

xm with the following property. For arbitrary numbers x, Q with x ≥ xm, and x1/2 ≤ Q ≤

x1−1/m , and for an arbitrary integer a with 0 < |a| < x 1/m , we have 

π(x, q, a ) ≤ (4 /3 + c13 /m )x

ϕ(q) log( x/q )

for almost all integers q ∈ [Q, 2Q] with gcd( q, a ) = 1 , the number of exceptions being less than Qx −c14 /m .

This result was announced in [16], and a sketch of the proof was presented in [17]. No claim of effectivity for c13 , c 14 , x m was made by the authors, but their methods are effective. 

12. Sieved primes 

The goal of this section is to prove Theorem 5 from the Introduction. We begin with an elementary lemma, which puts more precision into (11.4). 

Lemma 12.1. Let ξ = ζ(2) ζ(3) /ζ (6) , where ζ is the Riemann zeta-function, and let 

ν = ∑

> u

(γ − log u)/(uϕ (u)) , where γ is the Euler–Mascheroni constant and u runs over squarefree numbers. We have for any real number t > 1 that 

∑

> d<t

1

ϕ(d) = ξ log t + ν + O

( log(2 t)

t

)

.

Proof . As in (11.4) and with u running over squarefree numbers, 

∑

> d<t

1

ϕ(d) = ∑

> u<t

1

uϕ (u)

∑

> d<t/u

1

d = ∑

> u<t

1

uϕ (u)

(

log 

( t

u

)

+ γ + O

( u

t

))

= (log t) ∑

> u<t

1

uϕ (u) + ∑

> u<t

γ − log u

uϕ (u) + O

(

1

t

∑

> u<t

1

ϕ(u)

)

= (log t) ∏ 

> pprime

(

1 + 1

p(p − 1) 

)

+

> ∞

∑

> u=1

γ − log u

uϕ (u) + O

( log(2 t)

t

)

= ξ log t + ν + O

( log(2 t)

t

)

.

Proof of Theorem 5. We shall prove the contrapositive of Theorem 5. Let x be a positive real number, and suppose we have a set of primes Q ⊂ (1 , x 1/2] such that ∑ 

> q∈Q

1/(q −1) ≤

0.2727. Let m > 10 4 be an integer and let β = 1 /m . Let 

L = ( x1/2−2β, x 1/2−β ) ∩ Z, H = ( x1/2+ β , x 1/2+2 β) ∩ Z.

40 For a prime r ≤ x, let g(r) denote the number of factorizations of r − 1 as lh , where 

l ∈ L , h ∈ H ,lh is not divisible by any member of Q,l is not divisible by s(x),h is not divisible by any prime larger than x1/2,

where s(x) is as in 11.2. It is possible that g(r) = 0; let N denote the number of primes 

r ≤ x with g(r) > 0. Then, in the notation of Theorem 5, we have R(x, Q) ≥ N . Our goal is to get a good lower bound for R(x, Q) and so it suffices to do so for N .From Cauchy’s inequality, we obtain 

N ≥

∑

> r≤x

g(r)

 

> 2

∑

> r≤x

g(r)2



> −1

.

Our first task is to get an upper bound for ∑ 

> r≤x

g(r)2, and to do this we shall ignore the non-divisibility requirements in the definition of g(r) and use only the relatively simple 11.1. We have, with [ a, b ] denoting the least common multiple of a, b ,

∑ 

> prime r≤x

g(r)2 ≤ ∑ 

> prime r≤x

∑    

> l1,l 2|r−1
> l1,l 2∈L

1 = ∑ 

> l1,l 2∈L

π(x, [l1, l 2], 1) .

By 11.1, we thus have 

∑ 

> prime r≤x

g(r)2 ≤ 2x ∑ 

> l1,l 2∈L

1

ϕ([ l1, l 2]) log( x/ [l1, l 2]) 

≤ x

β log x

∑  

> l1,l 2∈L

1

ϕ([ l1, l 2]) .

We have 

∑  

> l1,l 2∈L

1

ϕ([ l1, l 2]) = ∑

> d<x 1/2−β

∑    

> gcd( l1,l 2)= dl1,l 2∈L

1

ϕ(l1l2/d ) ≤ ∑

> d<x 1/2−β

∑ 

> a,b<x 1/2−β/d

1

ϕ(abd )

≤

 ∑

> d<x 1/2

1

ϕ(d)



> 3

≤ (log x)3,

41 the last inequality following from 12.1 for all x beyond an absolute bound. We conclude that ∑ 

> prime r≤x

g(r)2 ≤ β−1x(log x)2.

We now turn our attention to the heart of the proof, which is to obtain a reasonable lower bound for ∑ 

> r≤x

g(r), and for this we shall use 11.7 and 11.8. Let L1 denote the set of integers l ∈ L with l not divisible by s(x). To begin, we have 

∑ 

> prime r≤x

g(r) ≥ ∑

> l∈L 1

π(x, l, 1) − ∑

> l∈L 1

π(x1/2+ βl + 1 , l, 1) − ∑  

> l∈L 1
> q|lfor some q∈Q

π(x, l, 1) 

− ∑  

> h∈H
> q|hfor some q∈Q

π(x, h, 1) − ∑  

> h∈H
> q|hfor some prime q>x 1/2

π(x, h, 1) = S1 − S2 − S3 − S4 − S5, say .

Indeed, S1 counts the number of pairs l, h where lh + 1 is a prime r ≤ x and l ∈ L 1, while 

S2 removes from this count those pairs where h 6 ∈ H , S3 removes those pairs where l is divisible by some prime in Q, etc. For S1 we use 11.7 and get for x exceeding some bound depending on m,

S1 = li( x) ∑

> l∈L 1

1

ϕ(l) + O

( x

(log x)2

)

.

By 12.1 and using s(x) ≥ (log x)1/2, we have for x above some bound depending on m,

S1 = ξβx + O(x/ (log x)1/4).

By 11.1, we have 

S2 = O

(

x1/2+ β

log x

∑

> l∈L 1

l

ϕ(l)

)

.

From an argument like (11.4), one has ∑ 

> l∈L 1

l/ϕ (l) = O(x1/2−β), so S2 = O(x/ log x). For S3 we use 11.7 and get for x exceeding a bound depending on m,

S3 ≤ li( x) ∑

> q∈Q

∑ 

> l∈L 1, q |l

1

ϕ(l) + O

( x

(log x)2

)

≤ li( x) ∑

> q∈Q

1

q − 1

∑

> qk ∈L

1

ϕ(k) + O

( x

(log x)2

)

.

42 By 12.1 we have for q ∈ Q that 

∑

> qk ∈L

1

ϕ(k)



= ξβ log x + O(q log(2 x)x2β−1/2) for q < x 1/2−2β;

≤ ξβ log x + ν + O(q log(2 x)xβ−1/2) for x1/2−2β ≤ q ≤ x1/2−β ;= 0 for q > x 1/2−β .Thus, 

S3 ≤ ξβx ∑

> q∈Q

1

q − 1 + O

( x

log x

)

.

We estimate S4 by using 11.8 with “ m” chosen as our current m and with “ Q” being various powers of 2 so that the intervals [ Q, 2Q] cover the interval ( x1/2+ β , x 1/2+2 β). If h

is an exceptional modulus in 11.8, we use the trivial estimate π(x, h, 1) ≤ x/h . Thus, for 

x exceeding some bound depending on m,

S4 = ∑  

> h∈H
> q|hfor some q∈Q

π(x, h, 1) 

≤ (4 /3 + O(β)) x ∑  

> h∈H
> q|hfor some q∈Q

1

ϕ(h) log( x/h ) + O

( x

log x

)

≤ (8 /3 + O(β)) x

log x

∑  

> h∈H
> q|hfor some q∈Q

1

ϕ(h) + O

( x

log x

)

≤ (8 /3 + O(β)) x

log x

∑

> q∈Q

1

q − 1

∑

> qm ∈H

1

ϕ(m) + O

( x

log x

)

= (8 /3 + O(β)) ξβx ∑

> q∈Q

1

q − 1 + O

( x

log x

)

.

For S5 it is sufficient to use 11.1. Note that 

∑  

> h∈H
> q|hfor some prime q>x 1/2

1

ϕ(h) ≤ ∑  

> x1/2<q ≤x1/2+2 β
> qprime

1

q − 1

∑

> t≤x2β

1

ϕ(t) .

By Mertens’ theorem, the first sum on the right is O(β), and by 12.1, the second sum is 

O(β log x). Thus, the sum ∑ 1/ϕ (h) is O(β2 log x), so that we have 

S5 ≤ 2x ∑  

> h∈H
> q|hfor some prime q>x 1/2

1

ϕ(h) log( x/h )= O

(

x

log x

∑  

> h∈H
> q|hfor some prime q>x 1/2

1

ϕ(h)

)

= O(β2x).

43 Putting together our estimates for S1, S 2, S 3, S 4, S 5 we have that for x ≥ xm′ ,

∑ 

> prime r≤x

g(r) ≥ S1 − S2 − S3 − S4 − S5

≥ ξβx 

(

1 − (11 /3 + O(β)) ∑

> q∈Q

1

q − 1

)

+ O(β2x) + O(x/ (log x)1/4)

≥ ξβx (1 − (11 /3 + O(β))0 .2727 ) + O(x/ (log x)1/4)= ξβx (10 −4 + O(β)) + O(x/ (log x)1/4).

Thus, there is some absolute, computable, positive integer c15 such that if m = c15 and 

β = 1 /m , we have ∑ 

> prime r≤x

g(r) ≥ ξx/m 2 = ξx/c 215 

for x ≥ X0, where X0 is a computable constant. Using this with our upper bound for 

∑ 

> r≤x

g(r)2 and choosing δ = ξ2/c 515 , we get that N ≥ δx/ (log x)2. This completes the proof of Theorem 5. 

Remarks . By using results of Bombieri–Friedlander–Iwaniec instead of 11.8 and the method of Friedlander [20] instead of Balog, one may not only replace “0 .2727” with “1 /2” in Theorem 5, but the number of primes r satisfying the condition is of order of magnitude 

π(x). However, these tools involve constants that are not effectively computable. If one is not concerned with effective constants, this stronger form of Theorem 5 would support the conclusion of 2.15 with “46 /25” replaced with any fixed number c > 1 (and with “c4” depending on c). It is likely that the work of Baker–Harman would lead to a further (ineffective) improvement. See also [21]. 

13. The existence of period systems 

In this section we prove 2.15. We first show that there are many period pairs for n.

Proposition 13.1. Let n be an integer, n > 1, and let w, y be real numbers. Each prime number r satisfies at least one of the following conditions: 

(i) the element (n mod r) of Fr is either zero or has multiplicative order at most w;

(ii) the number r − 1 has a divisor m > w composed of primes at most y;

(iii) there is an integer q with q > y and q2 | r − 1;

(iv) there is a prime q such that q > y and (r, q ) is a period pair for n.

Proof. If ( n mod r) does not belong to F∗ 

> r

then (i) holds. Suppose ( n mod r) ∈ F∗ 

> r

, and let 

m be the order of ( n mod r) in F∗ 

> r

. Then m divides r − 1. If m ≤ w, then (i) holds, so 44 suppose m > w . If m has no prime factor exceeding y, then (ii) holds. Suppose therefore that q is a prime factor of m with q > y ; then q equals the order of ( nm/q mod r). If 

q divides ( r − 1) /m , then (iii) holds. If q does not divide ( r − 1) /m , then the element (n(r−1) /q mod r) = ( nm/q mod r)(r−1) /m has order q, and (iv) holds. This proves 13.1. Let ρ: R≥0 → R>0 denote the Dickman–de Bruijn function. That is, ρ is the continuous solution to the equation ρ′(u) = −uρ (u − 1) for u > 1, with the initial condition ρ(u) = 1 on [0 , 1]. From [13] we have (13 .2) log ρ(u) = −u · log( u log u) + O(u) for u ≥ 2.

Lemma 13.3. Let x, u, v be real numbers with x ≥ 20 , 1 ≤ v ≤ u ≤ √(log x) log log x,and put y = x1/u , w = yv . The number of prime numbers r ≤ x satisfying 13.1(ii) is at most 

O

(

uπ (x)

( ρ(v)

log(2 v) + ρ(u)

))

.

Proof. This is Theorem 2 from [27]. 

Proposition 13.4. For all sufficiently large integers n, if x is a real number such that 

x ≥ (log n)1.001 , then the number of prime numbers r ≤ x for which there does not exist a period pair (r, q ) for n satisfying 

q is prime , q > x 1/(log log x)2

is at most x/ (log x)3.

Proof. By 13.1, it suffices to show that when n is a sufficiently large integer and x is a real number with x ≥ (log n)1.001 , the number of primes r ≤ x satisfying one of 13.1(i)–(iii), with w = x1/ log log x and y = x1/(log log x)2

, is at most x/ (log x)3. We prove this by showing that the number of such primes r is o(x/ (log x)3) as n → ∞ .If the prime r satisfies 13.1(i), then either r | n or r | nm − 1 for some integer m

in [1 , w ]. Since the number of distinct prime divisors of a positive integer k is at most (log k)/ log 2, the number of primes r satisfying 13.1(i) is at most log n

log 2 + ∑

> m≤w

m · log n

log 2 ≤ w2 · log n

log 2 ≤ 2x1000 /1001+2 / log log x = o(x/ (log x)3)

as n → ∞ .45 To estimate the number of primes r ≤ x satisfying 13.1(ii) we apply 13.3 with v =log log x and u = v2; one finds via (13.2) that as n → ∞ , this number is at most 

x/ (log x)(1+ o(1)) log log log x = o(x/ (log x)3).

The number of integers r with 1 < r ≤ x satisfying 13.1(iii) is clearly at most 

∑ 

> q>y

x/q 2 < x/ (y − 1) = o(x/ (log x)3) as n → ∞ .This proves 13.4. Let n be an integer at least 20 and choose real numbers x, u with (13 .5) x ≥ (log n)1.001 , u = (log log x)2.

For a prime r, let Q(r) = Q(r, n, x, u ) denote the set of prime divisors q of r − 1 with 

x1/u < q ≤ x1/2 and (r, q ) is a period pair for n.Further, let Q = Q(n, x, u ) denote the union of the sets Q(r) over all primes r ≤ x. Note that each subset S of Q corresponds to at least one period system for n with degree ∏ 

> q∈S

q

and where each pair ( r, q ) used satisfies r ≤ x, q ≤ x1/2, and q prime. 

Proposition 13.6. For all sufficiently large integers n and with x, u as in (13 .5) , we have 

∑

> q∈Q

1

q − 1 > 0.2727 .

Proof. Let 

A = {prime r ≤ x : prime q | r − 1 implies q ≤ x1/2 and q 6 ∈ Q} ,

B = {prime r ≤ x : prime q | r − 1 implies q ≤ x1/u or ( r, q ) is not a period pair for n}.

Clearly A ⊂ B . We use Theorem 5. Suppose n is so large that Theorem 5 and 13.4 hold for all x ≥ (log n)1.001 . Since 13.4 implies that # B ≤ x/ (log x)3, we have # A ≤ x/ (log x)3.Using Theorem 5, the conclusion of 13.6 now follows for sufficiently large x, completing the proof. 

Proof of Proposition 2.15. Let n, D be integers with n ≥ 20 and D > (log n)46 /25 . Further, let α = 0 .2726, let x = D(25 /46)1 .001 (so that (log n)1.001 < x < D 6/11 ), and let u =46 (log log x)2. Then (13.5) holds. Let ǫ = 10 −4 and let c4 ≥ 20 be so large that n ≥ c4

implies that 13.6 holds, 

x−1/u < ǫ, 2 < u < (log x)1/10 , α

4u > 1

15(log log D)2 ,

and x ≥ x0(α, ǫ ) in 10.1. With Q as above, we have ∑ 

> q∈Q

1/q > ∑ 

> q∈Q

1/(q − 1) −

x−1/u > 0.2727 − ǫ = α. We apply 10.1 with the current choices for α, ǫ, x, u, Q, noting that 1 /(2( α − ǫ)) < 46 /25. Since (log D)5u < exp(5(log log D)3), we thus have 2.15 with 

c5 = 15. 

References 

1. L. M. Adleman and H. W. Lenstra, Jr., Finding irreducible polynomials over finite fields , Proc. 18th Annual ACM Symp. on Theory of Computing (STOC), Berkeley, May 28–30, 1986, 350–355. 2. M. Agrawal, N. Kayal, and N. Saxena, PRIMES is in P, Ann. of Math. 160 (2004), 781–793. 3. M. F. Atiyah and I. G. Macdonald, Introduction to commutative algebra , Addison-Wesley, Reading, Mass., 1969. 4. R. M. Avanzi and P. Mih˘ ailescu, Efficient “quasi”-deterministic primality test improv-ing AKS, http://www.uni-math.gwdg.de/preda/mihailescu-papers/ouraks3.pdf. 5. A. Balog, p + a without large prime factors , in Seminar on number theory, 1983–1984 (Talence, 1983/1984), Exp. No. 31, 5 pp., Univ. Bordeaux I, Talence, 1984. 6. D. J. Bernstein, Proving primality in essentially quartic random time , Math. Comp. 

76 (2007), 389–403. 7. D. J. Bernstein, Fast multiplication and its applications , in J. P. Buhler, P. Stevenhagen (eds), Algorithmic number theory , 325–384, MSRI Publications 44 , Cambridge U. Press, New York, 2008. 8. D. J. Bernstein, H. W. Lenstra, Jr., and J. Pila, Detecting perfect powers by factoring into coprimes , Math. Comp. 76 (2007), 385–388. 9. P. Berrizbeitia, Sharpening “ PRIMES is in P” for a large family of numbers , Math. Comp. 74 (2005), 2043–2059. 10. D. Bleichenbacher, The continuous postage problem , unpublished manuscript, 2003. 11. A. Bostan, P. Flajolet, B. Salvy, and ´E. Schost, Fast computation of special resultants ,J. Symbolic Comput. 41 (2006), 1–29. 47 12. R. P. Brent, Fast multiple-precision evaluation of elementary functions , J. Assoc. Com-put. Mach. 23 (1976), 242–251. 13. N. G. de Bruijn, The asymptotic behaviour of a function occurring in the theory of primes , J. Indian Math. Soc. (N.S.) 15 (1951), 25–32. 14. J. W. S. Cassels, An introduction to the geometry of numbers , Springer-Verlag, Berlin, second edition, 1971. 15. H. Davenport, Multiplicative number theory , Second edition (revised by H. L. Mont-gomery), Graduate Texts in Mathematics, 74. Springer-Verlag, New York–Berlin, 1980. 16. J.-M. Deshouillers and H. Iwaniec, Kloosterman sums and Fourier coefficients of cusp forms , Invent. Math. 70 (1982/83), 219–288. 17. J.-M. Deshouillers and H. Iwaniec, On the Brun–Titchmarsh theorem on average , in Topics in classical number theory (G. Hal´ asz, ed.), Vol. I, (Budapest, 1981), 319–333, Colloq. Math. Soc. J´ anos Bolyai, 34 , North-Holland, Amsterdam, 1984. 18. P. Erd˝ os, On the normal number of prime factors of p − 1 and some related problems concerning Euler’s ϕ-function , Quart. J. Math. (Oxford Ser.) 6 (1935), 205–213. 19. J. Farkas, Theorie der einfachen Ungleichungen , J. Reine Angew. Math. 124 (1902), 1–27. 20. J. B. Friedlander, Shifted primes without large prime factors , in Number theory and applications (R. A. Mollin, ed.), Kluwer Academic Publishers, Dordrecht, 1989, pp. 393–401. 21. A. Granville, D. Koukoulopoulis, and K. Matom¨ aki, When the sieve works , preprint. 22. M. N. Huxley, On the difference between consecutive primes , Invent. Math. 15 (1972), 164–170. 23. S. Lang, Algebra , revised third edition, Springer-Verlag, New York, 2002. 24. V. F. Lev, The continuous postage stamp problem , J. London Math. Soc. 73 (2006), 625–638. 25. R. Lidl and H. Niederreiter, Finite fields , Addison-Wesley Publishing company, Read-ing (Mass.), 1983. 26. H. L. Montgomery and R. C. Vaughan, The large sieve , Mathematika 20 (1973), 119–134. 27. C. Pomerance and I. E. Shparlinski, Smooth orders and cryptographic applications ,Algorithmic Number Theory (Sydney, 2002), 338–348, Lecture Notes in Comput. Sci. 48 2369 , Springer, Berlin, 2002. 28. V. Shoup, Fast construction of irreducible polynomials over finite fields , J. Symbolic Computation 17 (1994), 371–391. 29. N. M. Timofeev, The Vinogradov–Bombieri theorem (in Russian), Mat. Zametki 38 

(1985), 801–809, 956. 30. J. von zur Gathen and J. Gerhard, Modern computer algebra , Cambridge University Press, Cambridge, 1999. H. W. Lenstra jr. Mathematisch Instituut Universiteit Leiden Postbus 9512 2300 RA Leiden The Netherlands Carl Pomerance Department of Mathematics Dartmouth College Hanover, NH 03755 USA 49
